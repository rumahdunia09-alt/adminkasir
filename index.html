<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Export Pro v16</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #2c3e50; --a: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; }
        
        /* Sidebar */
        #sidebar { width: 240px; background: var(--p); height: 100vh; color: white; position: fixed; display: none; }
        .nav-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: #bdc3c7; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--a); color: white; }

        /* Content */
        #main { margin-left: 240px; width: calc(100% - 240px); display: none; }
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .container { padding: 25px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Table & Form */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        th { background: #fafafa; color: #666; }
        input, button { padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { background: var(--a); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-export { background: #27ae60; width: auto; padding: 10px 20px; margin-bottom: 10px; }

        #loginPage { position: fixed; inset: 0; background: var(--p); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-box">
            <h2 style="margin-bottom:20px">IKAMAPUSAT</h2>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="sidebar">
        <div style="padding:25px; font-weight:bold; font-size:20px; border-bottom:1px solid #34495e">POS CLOUD</div>
        <nav style="margin-top:10px">
            <div class="nav-item active" onclick="show('dash',this)"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="show('kasir',this)"><i class="fas fa-shopping-cart"></i> Kasir</div>
            <div class="nav-item" onclick="show('master',this)"><i class="fas fa-box"></i> Master Barang</div>
            <div class="nav-item" onclick="show('riwayat',this)"><i class="fas fa-history"></i> Riwayat</div>
        </nav>
    </div>

    <div id="main">
        <header>
            <div id="pageTitle" style="font-weight:bold; color:var(--p)">DASHBOARD</div>
            <button onclick="location.reload()" style="width:auto; background:#e74c3c">Logout</button>
        </header>

        <div class="container">
            <div id="dashPage" class="page" style="display:block">
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px">
                    <div class="card" style="border-left:5px solid #3498db">Total Produk <h2 id="countBarang">0</h2></div>
                    <div class="card" style="border-left:5px solid #2ecc71">Total Transaksi <h2 id="countTrx">0</h2></div>
                </div>
            </div>

            <div id="kasirPage" class="page" style="display:none">
                <div class="card">
                    <input type="text" id="scan" placeholder="Scan Barcode / Cari Nama..." onkeypress="cariBarang(event)">
                    <table>
                        <thead><tr><th>Nama</th><th>Qty</th><th>Subtotal</th></tr></thead>
                        <tbody id="cartBody"></tbody>
                    </table>
                    <h2 id="totalHarga" style="text-align:right">Total: Rp 0</h2>
                    <button onclick="prosesBayar()" style="background:#2ecc71">SIMPAN TRANSAKSI</button>
                </div>
            </div>

            <div id="masterPage" class="page" style="display:none">
                <div class="card">
                    <h3>Data Master Barang</h3>
                    <button class="btn-export" onclick="exportKeExcel()"><i class="fas fa-file-excel"></i> Export ke Excel (.csv)</button>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>Kode</th><th>Nama</th><th>Harga</th><th>Stok</th></tr></thead>
                            <tbody id="masterBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3>Tambah Barang Baru</h3>
                    <input type="text" id="m_kode" placeholder="Kode Barcode">
                    <input type="text" id="m_nama" placeholder="Nama Barang">
                    <input type="number" id="m_harga" placeholder="Harga Jual">
                    <input type="number" id="m_stok" placeholder="Stok">
                    <button onclick="tambahBarang()">SIMPAN DATA</button>
                </div>
            </div>

            <div id="riwayatPage" class="page" style="display:none">
                <div class="card">
                    <h3>Riwayat Penjualan</h3>
                    <table>
                        <thead><tr><th>Tanggal</th><th>Total</th><th>Kasir</th></tr></thead>
                        <tbody id="riwayatBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
            authDomain: "kasir-ikamapusat.firebaseapp.com",
            databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kasir-ikamapusat",
            storageBucket: "kasir-ikamapusat.firebasestorage.app",
            messagingSenderId: "375649394523",
            appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let listBarang = [], listRiwayat = [], keranjang = [];

        // LOAD DATA DARI DATABASE V13 (Folder utama Anda)
        db.ref('v13_barang').on('value', snap => {
            listBarang = snap.val() || [];
            updateMasterTable();
            document.getElementById('countBarang').innerText = listBarang.length;
        });

        db.ref('v13_riwayat').on('value', snap => {
            listRiwayat = snap.val() || [];
            updateRiwayatTable();
            document.getElementById('countTrx').innerText = listRiwayat.length;
        });

        function login() {
            if(user.value === 'admin' && pass.value === '123') {
                loginPage.style.display = 'none';
                sidebar.style.display = 'block';
                main.style.display = 'block';
            } else { alert("User/Pass Salah!"); }
        }

        function show(id, el) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id+'Page').style.display = 'block';
            el.classList.add('active');
            pageTitle.innerText = id.toUpperCase();
        }

        function updateMasterTable() {
            masterBody.innerHTML = '';
            listBarang.forEach(b => {
                masterBody.innerHTML += `<tr><td>${b.kode}</td><td>${b.nama}</td><td>${b.harga}</td><td>${b.stok}</td></tr>`;
            });
        }

        function updateRiwayatTable() {
            riwayatBody.innerHTML = '';
            listRiwayat.forEach(r => {
                riwayatBody.innerHTML += `<tr><td>${r.waktu}</td><td>Rp ${r.total.toLocaleString()}</td><td>Admin</td></tr>`;
            });
        }

        // --- FUNGSI EXPORT EXCEL ---
        function exportKeExcel() {
            if (listBarang.length === 0) return alert("Data kosong!");
            
            // Header Excel
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "KODE,NAMA BARANG,HARGA JUAL,STOK\n";
            
            // Isi Data
            listBarang.forEach(b => {
                let row = `${b.kode},${b.nama},${b.harga},${b.stok}`;
                csvContent += row + "\n";
            });

            // Download File
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Database_Barang_IKAMAPUSAT.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function cariBarang(e) {
            if(e.key === 'Enter') {
                const b = listBarang.find(x => x.kode === scan.value || x.nama.toLowerCase().includes(scan.value.toLowerCase()));
                if(b) {
                    keranjang.push({...b, qty:1});
                    renderCart();
                }
                scan.value = '';
            }
        }

        function renderCart() {
            cartBody.innerHTML = ''; let t = 0;
            keranjang.forEach(k => {
                let sub = k.qty * k.harga; t += sub;
                cartBody.innerHTML += `<tr><td>${k.nama}</td><td>${k.qty}</td><td>${sub}</td></tr>`;
            });
            totalHarga
