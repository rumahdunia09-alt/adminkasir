<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="UTF-8">
<title>Laporan Transaksi (Refactor Aman)</title>
<style>
body{font-family:Arial;margin:20px;background:#f6f6f6}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:20px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
th{background:#eee}
tr:hover{background:#f1f1f1}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.btn-detail{background:#3498db;color:#fff}
.btn-close{background:#e74c3c;color:#fff}
.hidden{display:none}
#popupDetail{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center}
#popupBox{background:#fff;padding:20px;width:600px;max-height:90vh;overflow:auto;border-radius:10px}
</style>
</head>
<body>

<div class="card">
<h2>Laporan Transaksi</h2>
<table>
<thead>
<tr><th>Waktu</th><th>Kasir</th><th>Total</th><th>Aksi</th></tr>
</thead>
<tbody id="bodyLaporan"></tbody>
</table>
</div>

<div class="card">
<h2>Laporan Per Kasir</h2>
<table>
<thead><tr><th>Kasir</th><th>Transaksi</th><th>Item</th><th>Omzet</th></tr></thead>
<tbody id="bodyKasir"></tbody>
</table>
</div>

<div class="card">
<h2>Barang Terlaris</h2>
<table>
<thead><tr><th>Barang</th><th>Qty</th><th>Omzet</th></tr></thead>
<tbody id="bodyTerlaris"></tbody>
</table>
</div>

<!-- POPUP DETAIL -->

<div id="popupDetail" class="hidden">
  <div id="popupBox">
    <div id="popupIsi"></div>
    <div style="text-align:right;margin-top:10px">
      <button class="btn-close" onclick="tutupPopup()">Keluar</button>
    </div>
  </div>
</div>

<script>
// ===== DATA CONTOH (GANTI DENGAN FIREBASE) =====
const dbRiwayat=[
{waktu:'2026-02-06 10:00',kasir:'Ani',total:15000,items:[{nama:'Kopi',qty:1,harga:15000,subtotal:15000}]},
{waktu:'2026-02-06 10:10',kasir:'Budi',total:30000,items:[{nama:'Teh',qty:2,harga:5000,subtotal:10000},{nama:'Roti',qty:2,harga:10000,subtotal:20000}]}
];

// ===== RENDER LAPORAN UTAMA =====
function renderLaporan(){
  const body=document.getElementById('bodyLaporan');
  body.innerHTML='';
  dbRiwayat.forEach((r,i)=>{
    body.innerHTML+=`
      <tr>
        <td>${r.waktu}</td>
        <td>${r.kasir}</td>
        <td>Rp ${r.total.toLocaleString()}</td>
        <td><button class="btn-detail" onclick="bukaDetail(${i})">Detail</button></td>
      </tr>`;
  });
  renderPerKasir();
  renderTerlaris();
}

// ===== DETAIL TRANSAKSI =====
function bukaDetail(i){
  const r=dbRiwayat[i];
  document.getElementById('popupIsi').innerHTML=`
    <h3>Detail Transaksi</h3>
    <p><b>Waktu:</b> ${r.waktu}</p>
    <p><b>Kasir:</b> ${r.kasir}</p>
    <table>
      <tr><th>Barang</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr>
      ${r.items.map(it=>`
        <tr><td>${it.nama}</td><td>${it.qty}</td><td>${it.harga.toLocaleString()}</td><td>${it.subtotal.toLocaleString()}</td></tr>
      `).join('')}
    </table>
    <h3 style="text-align:right">Total: Rp ${r.total.toLocaleString()}</h3>`;
  document.getElementById('popupDetail').classList.remove('hidden');
}

function tutupPopup(){
  document.getElementById('popupDetail').classList.add('hidden');
}

// ===== LAPORAN PER KASIR =====
function renderPerKasir(){
  const map={};
  dbRiwayat.forEach(r=>{
    if(!map[r.kasir]) map[r.kasir]={trx:0,item:0,omzet:0};
    map[r.kasir].trx++;
    map[r.kasir].omzet+=r.total;
    r.items.forEach(i=>map[r.kasir].item+=i.qty);
  });
  const body=document.getElementById('bodyKasir');
  body.innerHTML='';
  Object.keys(map).forEach(k=>{
    const v=map[k];
    body.innerHTML+=`<tr><td>${k}</td><td>${v.trx}</td><td>${v.item}</td><td>Rp ${v.omzet.toLocaleString()}</td></tr>`;
  });
}

// ===== BARANG TERLARIS =====
function renderTerlaris(){
  const map={};
  dbRiwayat.forEach(r=>r.items.forEach(i=>{
    if(!map[i.nama]) map[i.nama]={qty:0,omzet:0};
    map[i.nama].qty+=i.qty;
    map[i.nama].omzet+=i.subtotal;
  }));
  const body=document.getElementById('bodyTerlaris');
  body.innerHTML='';
  Object.entries(map).sort((a,b)=>b[1].qty-a[1].qty).forEach(([n,v])=>{
    body.innerHTML+=`<tr><td>${n}</td><td>${v.qty}</td><td>Rp ${v.omzet.toLocaleString()}</td></tr>`;
  });
}

renderLaporan();
</script>

</body>
</html>
