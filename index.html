<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.1 - Professional POS</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); }
        
        #loginOverlay { position: fixed; inset: 0; background: var(--dark); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 30px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative; }
        
        .navbar { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 12px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; transition: 0.3s; }
        .menu-item.active { background: var(--p); }
        
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { padding: 20px; border-radius: 10px; color: white; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; }

        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-p { background: var(--p); } .btn-s { background: var(--s); } .btn-d { background: var(--d); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2 style="color: var(--p); margin-top:0">IKAMAPUSAT</h2>
            <p style="color: #666; font-size: 14px;">Aplikasi Kasir & Inventori</p>
            <input type="text" id="userIn" placeholder="Username" style="margin-bottom: 10px;" autocomplete="off">
            <input type="password" id="passIn" placeholder="Password" style="margin-bottom: 15px;">
            
            <div style="text-align: left; margin-bottom: 15px; font-size: 13px; color: #555;">
                <input type="checkbox" id="rememberMe" style="width: auto; cursor: pointer;"> Tetap Login
            </div>

            <button class="btn btn-p" style="width: 100%" onclick="handleLogin()">MASUK</button>
            <p style="font-size: 10px; color: #999; margin-top: 15px;">Admin: admin (123) | Kasir: bebas (kasir)</p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="navbar">
            <h3 style="margin:0">IKAMA <span style="font-size:12px; background:#eee; padding:2px 8px; border-radius:10px">v26.1</span></h3>
            <div id="curUser" style="font-weight: bold; color: var(--p);"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showP('kasir', this)"><i class="fas fa-cash-register"></i> KASIR</div>
            <div id="adminMenu" style="display: none;">
                <div class="menu-item" onclick="showP('laporan', this)"><i class="fas fa-chart-line"></i> LAPORAN</div>
                <div class="menu-item" onclick="showP('opname', this)"><i class="fas fa-boxes"></i> STOK OPNAME</div>
                <div class="menu-item" onclick="showP('master', this)"><i class="fas fa-database"></i> DATABASE</div>
            </div>
            <div class="menu-item" onclick="logout()" style="background: var(--d); margin-left: auto;">KELUAR</div>
        </div>

        <div class="container">
            <div id="p-kasir" class="section">
                <div style="display:grid; grid-template-columns: 1.8fr 1fr; gap:20px">
                    <div class="card">
                        <input type="text" id="scanIn" placeholder="Scan Barcode / Ketik Nama..." style="font-size: 20px; border: 2px solid var(--p);" onkeypress="checkScan(event)" autofocus>
                        <table style="margin-top: 20px;">
                            <thead><tr><th>Produk</th><th>Unit</th><th>Harga</th><th width="80">Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="cartBody"></tbody>
                        </table>
                    </div>
                    <div class="card" style="text-align: right;">
                        <p style="margin:0">Total Tagihan:</p>
                        <h1 id="totalTagihan" style="font-size: 50px; margin: 0; color: var(--p);">Rp 0</h1>
                        <hr>
                        <label>Tunai Diterima:</label>
                        <input type="number" id="bayarTunai" style="font-size: 25px; text-align: right; margin: 10px 0;" oninput="calcChange()">
                        <h2 id="kembalian" style="color: var(--d); margin-top:0">Kembali: Rp 0</h2>
                        <button class="btn btn-s" style="width: 100%; padding: 20px; font-size: 20px;" onclick="doCheckout()">PROSES BAYAR</button>
                    </div>
                </div>
            </div>

            <div id="p-laporan" class="section hidden">
                <div class="grid-stats">
                    <div class="stat-box" style="background: var(--p);">
                        <small>Omset Hari Ini</small><h2 id="omsetHari">Rp 0</h2>
                    </div>
                    <div class="stat-box" style="background: var(--s);">
                        <small>Profit Hari Ini</small><h2 id="profitHari">Rp 0</h2>
                    </div>
                    <div class="stat-box" style="background: var(--dark);">
                        <small>Total Transaksi</small><h2 id="countTrx">0</h2>
                    </div>
                </div>
                <div class="card">
                    <h3>Riwayat Penjualan</h3>
                    <table>
                        <thead><tr><th>Jam</th><th>Kasir</th><th>Items</th><th>Total</th><th>Profit</th></tr></thead>
                        <tbody id="histBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="p-opname" class="section hidden">
                <div class="card">
                    <h3>Update Stok Fisik</h3>
                    <input type="text" id="cariOpname" placeholder="Cari nama barang..." oninput="renderOpname()" style="margin-bottom:15px">
                    <table>
                        <thead><tr><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik Baru</th><th>Aksi</th></tr></thead>
                        <tbody id="opnameBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="p-master" class="section hidden">
                <div class="card">
                    <h3>Database Tools</h3>
                    <button class="btn btn-p" onclick="downloadTemplate()"><i class="fas fa-download"></i> Download Template</button>
                    <div style="margin-top:15px; border: 1px dashed #ccc; padding: 15px; border-radius: 8px;">
                        <label>Upload Excel:</label>
                        <input type="file" id="xlIn" accept=".xlsx" style="margin: 10px 0;">
                        <button class="btn btn-s" onclick="importExcel()">Update Database</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // KONFIGURASI FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dbBarang = [], cart = [], history = [], curUser = "";

    // Sinkronisasi Realtime
    db.ref('v26_master').on('value', s => { dbBarang = s.val() || []; renderOpname(); });
    db.ref('v26_trx').on('value', s => { history = s.val() || []; renderLaporan(); });

    // --- SISTEM LOGIN (AUTO-CHECK) ---
    window.onload = function() {
        const savedUser = localStorage.getItem('ikamapusat_user');
        const savedRole = localStorage.getItem('ikamapusat_role');
        
        if (savedUser && savedRole) {
            curUser = savedUser;
            if (savedRole === 'ADMIN') {
                document.getElementById('adminMenu').style.display = 'contents';
            }
            lanjutMasuk();
        } else {
            document.getElementById('userIn').focus();
        }
    };

    function handleLogin() {
        const u = document.getElementById('userIn').value.trim();
        const p = document.getElementById('passIn').value.trim();
        const remember = document.getElementById('rememberMe').checked;
        
        if (u === "" || p === "") return alert("Isi Username dan Password!");

        let role = "";
        if (u.toLowerCase() === "admin" && p === "123") {
            curUser = "ADMIN";
            role = "ADMIN";
            document.getElementById('adminMenu').style.display = 'contents';
        } else if (p === "kasir") {
            curUser = u.toUpperCase();
            role = "KASIR";
            document.getElementById('adminMenu').style.display = 'none';
        } else {
            return alert("Login Gagal! Password salah.");
        }

        if (remember) {
            localStorage.setItem('ikamapusat_user', curUser);
            localStorage.setItem('ikamapusat_role', role);
        }
        lanjutMasuk();
    }

    function lanjutMasuk() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('curUser').innerText = "USER: " + curUser;
        setTimeout(() => document.getElementById('scanIn').focus(), 500);
    }

    function logout() {
        localStorage.removeItem('ikamapusat_user');
        localStorage.removeItem('ikamapusat_role');
        location.reload();
    }

    function showP(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('p-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        if(el) el.classList.add('active');
    }

    // --- KASIR ---
    function checkScan(e) {
        if(e.key === 'Enter') {
            const v = e.target.value;
            if(!v) return;
            let found = null, lv = 1;
            dbBarang.forEach(b => {
                if(b.u1 && b.u1.bar === v) { found=b; lv=1; }
                else if(b.u2 && b.u2.bar === v) { found=b; lv=2; }
                else if(b.u3 && b.u3.bar === v) { found=b; lv=3; }
                else if(b.u4 && b.u4.bar === v) { found=b; lv=4; }
                else if(b.nama.toLowerCase().includes(v.toLowerCase())) { found=b; lv=1; }
            });
            if(found) {
                const u = found['u'+lv];
                cart.push({ id: found.kode, nama: found.nama, unit: u.name, harga: u.jual, modal: found.hpp, konv: u.konv, qty: 1 });
                renderCart();
            } else {
                alert("Barang tidak ditemukan!");
            }
            e.target.value = '';
        }
    }

    function renderCart() {
        const b = document.getElementById('cartBody'); b.innerHTML = '';
        let total = 0;
        cart.forEach((c, i) => {
            let sub = c.harga * c.qty; total += sub;
            b.innerHTML += `<tr><td>${c.nama}</td><td>${c.unit}</td><td>${c.harga.toLocaleString()}</td><td><input type="number" value="${c.qty}" onchange="updateQty(${i},this.value)" style="width:60px"></td><td>${sub.toLocaleString()}</td><td onclick="cart.splice(${i},1);renderCart()" style="color:red;cursor:pointer">âœ–</td></tr>`;
        });
        document.getElementById('totalTagihan').innerText = "Rp " + total.toLocaleString();
        calcChange();
    }

    function updateQty(i,v) { cart[i].qty = parseInt(v) || 1; renderCart(); }

    function calcChange() {
        const t = parseInt(document.getElementById('totalTagihan').innerText.replace(/\D/g,'')) || 0;
        const b = parseInt(document.getElementById('bayarTunai').value) || 0;
        document.getElementById('kembalian').innerText = "Kembali: Rp " + (b - t).toLocaleString();
    }

    function doCheckout() {
        if(cart.length === 0) return;
        const t = parseInt(document.getElementById('totalTagihan').innerText.replace(/\D/g,''));
        const b = parseInt(document.getElementById('bayarTunai').value) || 0;
        if(b < t) return alert("Uang kurang!");

        let profit = 0, itemNames = [];
        cart.forEach(c => {
            profit += (c.harga - (c.modal * c.konv)) * c.qty;
            itemNames.push(`${c.nama} (${c.qty} ${c.unit})`);
            const idx = dbBarang.findIndex(x => x.kode === c.id);
            if(idx !== -1) dbBarang[idx].stok -= (c.qty * c.konv);
        });

        const trx = { tgl: new Date().toLocaleDateString('id-ID'), jam: new Date().toLocaleTimeString(), user: curUser, items: itemNames.join(", "), total: t, profit: profit };
        db.ref('v26_trx').set([trx, ...history]);
        db.ref('v26_master').set(dbBarang).then(() => {
            alert("Transaksi Berhasil!"); 
            cart = []; 
            renderCart(); 
            document.getElementById('bayarTunai').value = '';
        });
    }

    // --- LAPORAN ---
    function renderLaporan() {
        const b = document.getElementById('histBody'); b.innerHTML = '';
        const today = new Date().toLocaleDateString('id-ID');
        let omset = 0, profit = 0;
        history.forEach(h => {
            if(h.tgl === today) {
                omset += h.total; profit += h.profit;
                b.innerHTML += `<tr><td>${h.jam}</td><td>${h.user}</td><td><small>${h.items}</small></td><td>${h.total.toLocaleString()}</td><td>${h.profit.toLocaleString()}</td></tr>`;
            }
        });
        document.getElementById('omsetHari').innerText = "Rp " + omset.toLocaleString();
        document.getElementById('profitHari').innerText = "Rp " + profit.toLocaleString();
        document.getElementById('countTrx').innerText = history.filter(x => x.tgl === today).length;
    }

    // --- STOK OPNAME ---
    function renderOpname() {
        const b = document.getElementById('opnameBody'); b.innerHTML = '';
        const cari = document.getElementById('cariOpname').value.toLowerCase();
        dbBarang.forEach((x, i) => {
            if(x.nama.toLowerCase().includes(cari)) {
                b.innerHTML += `<tr><td>${x.nama}</td><td>${x.stok}</td><td><input type="number" id="sop-${i}" style="width:100px"></td><td><button class="btn btn-p" onclick="upStok(${i})">Simpan</button></td></tr>`;
            }
        });
    }

    function upStok(i) {
        const v = document.getElementById('sop-'+i).value;
        if(v==="") return;
        dbBarang[i].stok = parseInt(v);
        db.ref('v26_master').set(dbBarang).then(() => alert("Stok Diupdate!"));
    }

    // --- IMPORT/TEMPLATE ---
    function downloadTemplate() {
        const h = [["KODE ITEM", "NAMA ITEM", "STOK AWAL SATUAN DASAR", "HARGA POKOK SATUAN 1", "SATUAN 1", "BARCODE SATUAN 1", "HARGA JUAL SATUAN 1", "SATUAN 2", "BARCODE SATUAN 2", "KONVERSI SATUAN 2", "HARGA JUAL SATUAN 2", "SATUAN 3", "BARCODE SATUAN 3", "KONVERSI I SATUAN 3", "HARGA JUAL SATUAN 3", "SATUAN 4", "BARCODE SATUAN 4", "KONVERSI SATUAN 4", "HARGA JUAL SATUAN 4"]];
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(h), "T");
        XLSX.writeFile(wb, "Template_IKAMA_v26.1.xlsx");
    }

    function importExcel() {
        const f = document.getElementById('xlIn').files[0];
        if(!f) return alert("Pilih file!");
        const r = new FileReader();
        r.onload = (e) => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets["T"]);
            let fix = [];
            data.forEach(r => {
                if(r["NAMA ITEM"]) fix.push({
                    kode: String(r["KODE ITEM"] || r["BARCODE SATUAN 1"] || Date.now()), 
                    nama: r["NAMA ITEM"], 
                    stok: parseInt(r["STOK AWAL SATUAN DASAR"]) || 0, 
                    hpp: parseInt(r["HARGA POKOK SATUAN 1"]) || 0,
                    u1: { name: r["SATUAN 1"]||"PCS", bar: String(r["BARCODE SATUAN 1"]||""), jual: parseInt(r["HARGA JUAL SATUAN 1"])||0, konv: 1 },
                    u2: { name: r["SATUAN 2"]||"", bar: String(r["BARCODE SATUAN 2"]||""), jual: parseInt(r["HARGA JUAL SATUAN 2"])||0, konv: parseInt(r["KONVERSI SATUAN 2"])||0 },
                    u3: { name: r["SATUAN 3"]||"", bar: String(r["BARCODE SATUAN 3"]||""), jual: parseInt(r["HARGA JUAL SATUAN 3"])||0, konv: parseInt(r["KONVERSI I SATUAN 3"])||0 },
                    u4: { name: r["SATUAN 4"]||"", bar: String(r["BARCODE SATUAN 4"]||""), jual: parseInt(r["HARGA JUAL SATUAN 4"])||0, konv: parseInt(r["KONVERSI SATUAN 4"])||0 }
                });
            });
            db.ref('v26_master').set(fix).then(() => alert("Import Berhasil!"));
        };
        r.readAsArrayBuffer(f);
    }
</script>
</body>
</html>
