<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.0 - Professional POS</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); overflow-x: hidden; }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        
        .navbar { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 12px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; }
        .menu-item.active { background: var(--p); }
        
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { padding: 20px; border-radius: 10px; color: white; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }

        input { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-p { background: var(--p); } .btn-s { background: var(--s); } .btn-d { background: var(--d); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card" style="width: 350px; text-align: center;">
            <h2 style="color: var(--p)">IKAMAPUSAT v26</h2>
            <p>Silakan Masuk</p>
            <input type="text" id="userIn" placeholder="Username Kasir" style="margin-bottom: 10px;">
            <input type="password" id="passIn" placeholder="Password" style="margin-bottom: 15px;">
            <button class="btn btn-p" style="width: 100%" onclick="handleLogin()">MASUK</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="navbar">
            <h3 style="margin:0">IKAMA <span style="color:var(--p)">v26.0</span></h3>
            <div id="curUser" style="font-weight: bold; color: var(--p);"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showP('kasir', this)">KASIR</div>
            <div id="adminMenu" class="hidden" style="display: contents;">
                <div class="menu-item" onclick="showP('laporan', this)">LAPORAN</div>
                <div class="menu-item" onclick="showP('opname', this)">STOK OPNAME</div>
                <div class="menu-item" onclick="showP('master', this)">DATABASE</div>
            </div>
            <div class="menu-item" onclick="location.reload()" style="background: var(--d)">KELUAR</div>
        </div>

        <div class="container">
            <div id="p-kasir" class="section">
                <div style="display:grid; grid-template-columns: 1.8fr 1fr; gap:20px">
                    <div class="card">
                        <input type="text" id="scanIn" placeholder="Scan Barcode Satuan Apapun..." style="font-size: 20px; border: 2px solid var(--p);" onkeypress="checkScan(event)">
                        <table style="margin-top: 20px;">
                            <thead><tr><th>Produk</th><th>Unit</th><th>Harga</th><th>Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="cartBody"></tbody>
                        </table>
                    </div>
                    <div class="card" style="text-align: right;">
                        <p style="margin:0">Total Tagihan:</p>
                        <h1 id="totalTagihan" style="font-size: 50px; margin: 0; color: var(--p);">Rp 0</h1>
                        <hr>
                        <label>Diterima (Tunai):</label>
                        <input type="number" id="bayarTunai" style="font-size: 25px; text-align: right; margin: 10px 0;" oninput="calcChange()">
                        <h2 id="kembalian" style="color: var(--d);">Kembali: Rp 0</h2>
                        <button class="btn btn-s" style="width: 100%; padding: 20px; font-size: 20px;" onclick="doCheckout()">PROSES TRANSAKSI</button>
                    </div>
                </div>
            </div>

            <div id="p-laporan" class="section hidden">
                <div class="grid-stats">
                    <div class="stat-box" style="background: var(--p);">
                        <small>Total Omset (Hari Ini)</small>
                        <h2 id="omsetHari">Rp 0</h2>
                    </div>
                    <div class="stat-box" style="background: var(--s);">
                        <small>Total Profit (Hari Ini)</small>
                        <h2 id="profitHari">Rp 0</h2>
                    </div>
                    <div class="stat-box" style="background: var(--dark);">
                        <small>Transaksi</small>
                        <h2 id="countTrx">0</h2>
                    </div>
                </div>
                <div class="card">
                    <h3>History Penjualan</h3>
                    <table id="histTable">
                        <thead><tr><th>Waktu</th><th>Kasir</th><th>Detail Item</th><th>Total</th><th>Profit</th></tr></thead>
                        <tbody id="histBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="p-opname" class="section hidden">
                <div class="card">
                    <h3><i class="fas fa-edit"></i> Stok Opname (Penyesuaian Barang)</h3>
                    <input type="text" id="cariOpname" placeholder="Cari nama barang untuk disesuaikan..." oninput="renderOpname()">
                    <table style="margin-top:15px">
                        <thead><tr><th>Nama Barang</th><th>Stok Sistem</th><th>Stok Fisik Baru</th><th>Aksi</th></tr></thead>
                        <tbody id="opnameBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="p-master" class="section hidden">
                <div class="card">
                    <h3>Import & Export</h3>
                    <button class="btn btn-p" onclick="downloadTemplate()">Download Template</button>
                    <input type="file" id="xlIn" accept=".xlsx" style="width: auto;">
                    <button class="btn btn-s" onclick="importExcel()">Upload Data</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dbBarang = [], cart = [], history = [], curUser = "";

    // Sync Data
    db.ref('v26_master').on('value', s => { dbBarang = s.val() || []; renderOpname(); });
    db.ref('v26_trx').on('value', s => { history = s.val() || []; renderLaporan(); });

    // --- LOGIN ---
    function handleLogin() {
        const u = document.getElementById('userIn').value;
        const p = document.getElementById('passIn').value;
        
        if(u === "admin" && p === "123") {
            curUser = "ADMIN";
            document.getElementById('adminMenu').classList.remove('hidden');
        } else if(u !== "" && p === "kasir") {
            curUser = u.toUpperCase();
        } else {
            return alert("Login Gagal!");
        }
        
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('curUser').innerText = "KASIR: " + curUser;
    }

    function showP(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('p-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // --- KASIR LOGIC ---
    function checkScan(e) {
        if(e.key === 'Enter') {
            const v = e.target.value;
            let found = null, lv = 1;
            
            dbBarang.forEach(b => {
                if(b.u1.bar === v) { found=b; lv=1; }
                else if(b.u2.bar === v) { found=b; lv=2; }
                else if(b.u3.bar === v) { found=b; lv=3; }
                else if(b.u4.bar === v) { found=b; lv=4; }
            });

            if(found) {
                const u = found['u'+lv];
                cart.push({ id: found.kode, nama: found.nama, unit: u.name, harga: u.jual, modal: found.hpp, konv: u.konv, qty: 1 });
                renderCart();
            }
            e.target.value = '';
        }
    }

    function renderCart() {
        const b = document.getElementById('cartBody'); b.innerHTML = '';
        let total = 0;
        cart.forEach((c, i) => {
            let sub = c.harga * c.qty; total += sub;
            b.innerHTML += `<tr><td>${c.nama}</td><td>${c.unit}</td><td>${c.harga.toLocaleString()}</td><td>${c.qty}</td><td>${sub.toLocaleString()}</td><td onclick="cart.splice(${i},1);renderCart()" style="color:red; cursor:pointer">âœ–</td></tr>`;
        });
        document.getElementById('totalTagihan').innerText = "Rp " + total.toLocaleString();
    }

    function calcChange() {
        const t = parseInt(document.getElementById('totalTagihan').innerText.replace(/\D/g,''));
        const b = parseInt(document.getElementById('bayarTunai').value) || 0;
        document.getElementById('kembalian').innerText = "Kembali: Rp " + (b - t).toLocaleString();
    }

    function doCheckout() {
        if(cart.length === 0) return;
        const t = parseInt(document.getElementById('totalTagihan').innerText.replace(/\D/g,''));
        const b = parseInt(document.getElementById('bayarTunai').value) || 0;
        if(b < t) return alert("Uang tidak cukup!");

        let profit = 0, items = [];
        cart.forEach(c => {
            profit += (c.harga - (c.modal * c.konv)) * c.qty;
            items.push(`${c.nama} (${c.qty} ${c.unit})`);
            const idx = dbBarang.findIndex(db => db.kode === c.id);
            if(idx !== -1) dbBarang[idx].stok -= (c.qty * c.konv);
        });

        const trx = {
            tgl: new Date().toLocaleDateString('id-ID'),
            jam: new Date().toLocaleTimeString(),
            user: curUser,
            items: items.join(", "),
            total: t,
            profit: profit
        };

        db.ref('v26_trx').set([trx, ...history]);
        db.ref('v26_master').set(dbBarang).then(() => {
            alert("Transaksi Sukses!");
            cart = []; renderCart();
            document.getElementById('bayarTunai').value = '';
            document.getElementById('kembalian').innerText = "Kembali: Rp 0";
        });
    }

    // --- LAPORAN LOGIC ---
    function renderLaporan() {
        const b = document.getElementById('histBody'); b.innerHTML = '';
        const tglSkrg = new Date().toLocaleDateString('id-ID');
        let omset = 0, profit = 0;

        history.forEach(h => {
            if(h.tgl === tglSkrg) {
                omset += h.total; profit += h.profit;
                b.innerHTML += `<tr><td>${h.jam}</td><td>${h.user}</td><td><small>${h.items}</small></td><td>${h.total.toLocaleString()}</td><td>${h.profit.toLocaleString()}</td></tr>`;
            }
        });
        document.getElementById('omsetHari').innerText = "Rp " + omset.toLocaleString();
        document.getElementById('profitHari').innerText = "Rp " + profit.toLocaleString();
        document.getElementById('countTrx').innerText = history.filter(x => x.tgl === tglSkrg).length;
    }

    // --- STOK OPNAME LOGIC ---
    function renderOpname() {
        const b = document.getElementById('opnameBody'); b.innerHTML = '';
        const cari = document.getElementById('cariOpname').value.toLowerCase();
        dbBarang.forEach((x, i) => {
            if(x.nama.toLowerCase().includes(cari)) {
                b.innerHTML += `<tr>
                    <td>${x.nama}</td>
                    <td><b>${x.stok}</b></td>
                    <td><input type="number" id="newStok-${i}" placeholder="Input fisik..."></td>
                    <td><button class="btn btn-p" onclick="updateStok(${i})">Update</button></td>
                </tr>`;
            }
        });
    }

    function updateStok(i) {
        const newVal = document.getElementById('newStok-'+i).value;
        if(newVal === "") return alert("Isi stok fisik!");
        dbBarang[i].stok = parseInt(newVal);
        db.ref('v26_master').set(dbBarang).then(() => alert("Stok " + dbBarang[i].nama + " disesuaikan."));
    }

    // --- IMPORT/EXPORT (Keep Previous Logic) ---
    function downloadTemplate() {
        const header = [["KODE ITEM", "NAMA ITEM", "STOK AWAL SATUAN DASAR", "HARGA POKOK SATUAN 1", "SATUAN 1", "BARCODE SATUAN 1", "HARGA JUAL SATUAN 1", "SATUAN 2", "BARCODE SATUAN 2", "KONVERSI SATUAN 2", "HARGA JUAL SATUAN 2", "SATUAN 3", "BARCODE SATUAN 3", "KONVERSI I SATUAN 3", "HARGA JUAL SATUAN 3", "SATUAN 4", "BARCODE SATUAN 4", "KONVERSI SATUAN 4", "HARGA JUAL SATUAN 4"]];
        const ws = XLSX.utils.aoa_to_sheet(header);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "T");
        XLSX.writeFile(wb, "Template_IKAMA.xlsx");
    }

    function importExcel() {
        const file = document.getElementById('xlIn').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets["T"]);
            let fix = [];
            data.forEach(r => {
                if(r["NAMA ITEM"]) fix.push({
                    kode: String(r["KODE ITEM"] || r["BARCODE SATUAN 1"]), nama: r["NAMA ITEM"],
                    stok: parseInt(r["STOK AWAL SATUAN DASAR"]) || 0, hpp: parseInt(r["HARGA POKOK SATUAN 1"]) || 0,
                    u1: { name: r["SATUAN 1"]||"PCS", bar: String(r["BARCODE SATUAN 1"]||""), jual: parseInt(r["HARGA JUAL SATUAN 1"])||0, konv: 1 },
                    u2: { name: r["SATUAN 2"]||"", bar: String(r["BARCODE SATUAN 2"]||""), jual: parseInt(r["HARGA JUAL SATUAN 2"])||0, konv: parseInt(r["KONVERSI SATUAN 2"])||0 },
                    u3: { name: r["SATUAN 3"]||"", bar: String(r["BARCODE SATUAN 3"]||""), jual: parseInt(r["HARGA JUAL SATUAN 3"])||0, konv: parseInt(r["KONVERSI I SATUAN 3"])||0 },
                    u4: { name: r["SATUAN 4"]||"", bar: String(r["BARCODE SATUAN 4"]||""), jual: parseInt(r["HARGA JUAL SATUAN 4"])||0, konv: parseInt(r["KONVERSI SATUAN 4"])||0 }
                });
            });
            db.ref('v26_master').set(fix).then(() => alert("Berhasil Sinkron!"));
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
