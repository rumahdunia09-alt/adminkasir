<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.0 - Advanced Inventory</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --dark: #2c3e50; --bg: #f1f3f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); }
        .navbar { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 12px 20px; border-radius: 5px; font-size: 14px; transition: 0.3s; white-space: nowrap; }
        .menu-item:hover, .menu-item.active { background: var(--p); }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-input { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #555; }
        .hidden { display: none !important; }
        .status-low { color: var(--d); font-weight: bold; background: #ffe9e9; padding: 4px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="loginPage" style="max-width:400px; margin:100px auto; text-align:center" class="card">
        <h2 style="color:var(--p)">IKAMAPUSAT v26</h2>
        <input type="text" id="username" placeholder="Username" style="margin-bottom:10px">
        <input type="password" id="password" placeholder="Password" style="margin-bottom:10px">
        <button onclick="doLogin()">MASUK SISTEM</button>
    </div>

    <div id="appContainer" class="hidden">
        <div class="navbar">
            <h3 style="margin:0">IKAMA <small style="font-weight:normal; color:var(--p)">v26.0</small></h3>
            <div id="userDisplay" style="font-weight:bold"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showPage('kasir', this)"><i class="fas fa-cash-register"></i> Kasir</div>
            <div class="menu-item" onclick="showPage('master', this)"><i class="fas fa-boxes"></i> Master Barang & Import</div>
            <div class="menu-item" onclick="showPage('laporan', this)"><i class="fas fa-chart-line"></i> Laporan</div>
            <div class="menu-item" onclick="location.reload()" style="background:var(--d)">Keluar</div>
        </div>

        <div class="container">
            <div id="page-kasir" class="section">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
                    <div class="card">
                        <h3>Input Penjualan</h3>
                        <input type="text" id="scanInput" placeholder="Scan Barcode (Semua Level Satuan)..." onkeypress="handleScan(event)" style="font-size:20px; border:2px solid var(--p)">
                        <table>
                            <thead><tr><th>Barang</th><th>Unit</th><th>Qty</th><th>Harga</th><th>Total</th><th>#</th></tr></thead>
                            <tbody id="cartBody"></tbody>
                        </table>
                    </div>
                    <div class="card" style="text-align:right">
                        <p>Total Belanja:</p>
                        <h1 id="totalText" style="font-size:50px; margin:0; color:var(--p)">Rp 0</h1>
                        <input type="number" id="payInput" placeholder="Tunai..." oninput="calcChange()" style="font-size:24px; text-align:right; margin:20px 0">
                        <h2 id="changeText">Kembali: Rp 0</h2>
                        <button onclick="checkout()" style="background:var(--s); padding:20px; font-size:20px">PROSES TRANSAKSI</button>
                    </div>
                </div>
            </div>

            <div id="page-master" class="section hidden">
                <div class="card" style="background: #eefbff; border: 1px solid #b6e4f4;">
                    <h3><i class="fas fa-file-import"></i> Import Database Excel</h3>
                    <p>Sesuaikan kolom Excel dengan gambar database (Nama, Barcode1-4, Konv1-4, Jual1-4, Poin1-4, dll).</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls">
                    <button onclick="importExcel()" style="margin-top:10px; background:var(--dark)">PROSES IMPORT SEKARANG</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between">
                        <h3>Daftar Barang</h3>
                        <input type="text" id="searchMaster" placeholder="Cari nama/barcode..." oninput="renderMaster()" style="width:300px">
                    </div>
                    <table id="masterTable">
                        <thead>
                            <tr>
                                <th>KODE</th><th>NAMA ITEM</th><th>STOK DASAR</th><th>SATUAN 1</th><th>SATUAN 2</th><th>SATUAN 3</th><th>SATUAN 4</th><th>AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="masterBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-laporan" class="section hidden">
                <div class="card">
                    <h3>Laporan Penjualan harian</h3>
                    <input type="date" id="filterDate" onchange="renderReport()" style="width:200px">
                    <table>
                        <thead><tr><th>Jam</th><th>Kasir</th><th>Items</th><th>Total</th><th>Profit</th><th>Poin Keluar</th></tr></thead>
                        <tbody id="reportBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database();

    let localDB = [], cart = [], history = [];

    // SYNC DATA
    dbRef.ref('v26_master').on('value', s => { localDB = s.val() || []; renderMaster(); });
    dbRef.ref('v26_history').on('value', s => { history = s.val() || []; renderReport(); });

    // AUTH
    function doLogin() {
        if(document.getElementById('username').value === 'admin') {
            document.getElementById('loginPage').className = 'hidden';
            document.getElementById('appContainer').className = '';
            document.getElementById('userDisplay').innerText = "Administrator";
        }
    }

    function showPage(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // LOGIC IMPORT EXCEL (Konsep Tabel Lengkap)
    function importExcel() {
        const file = document.getElementById('excelFile').files[0];
        if(!file) return alert("Pilih file!");
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if(confirm(`Import ${data.length} item?`)) {
                data.forEach(r => {
                    localDB.push({
                        kode: r["KODE ITEM"] || r["Barcode 1"] || Math.random().toString(36).substr(2, 9),
                        nama: r["NAMA ITEM"] || r["Nama"],
                        jenis: r["JENIS"] || "",
                        merek: r["MEREK"] || "",
                        stok_dasar: parseInt(r["STOK AWAL SATUAN DASAR"]) || 0,
                        stok_min: parseInt(r["STOK MINIMUM"]) || 0,
                        modal1: parseInt(r["HARGA POKOK SATUAN 1"]) || 0,
                        // Unit Data
                        u1: { name: r["SATUAN 1"], bar: String(r["BARCODE SATUAN 1"]), jual: parseInt(r["HARGA JUAL SATUAN 1"]), konv: 1, poin: parseInt(r["POIN 1"]) || 0 },
                        u2: { name: r["SATUAN 2"], bar: String(r["BARCODE SATUAN 2"]), jual: parseInt(r["HARGA JUAL SATUAN 2"]), konv: parseInt(r["KONVERSI SATUAN 2"]) || 0, poin: parseInt(r["POIN 2"]) || 0 },
                        u3: { name: r["SATUAN 3"], bar: String(r["BARCODE SATUAN 3"]), jual: parseInt(r["HARGA JUAL SATUAN 3"]), konv: parseInt(r["KONVERSI SATUAN 3"]) || 0, poin: parseInt(r["POIN 3"]) || 0 },
                        u4: { name: r["SATUAN 4"], bar: String(r["BARCODE SATUAN 4"]), jual: parseInt(r["HARGA JUAL SATUAN 4"]), konv: parseInt(r["KONVERSI SATUAN 4"]) || 0, poin: parseInt(r["POIN 4"]) || 0 }
                    });
                });
                dbRef.ref('v26_master').set(localDB);
                alert("Import Selesai!");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // LOGIC KASIR (Multi-Level Barcode)
    function handleScan(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('scanInput').value;
            let found = null;
            let level = 1;

            // Cari barcode di semua level u1-u4
            localDB.forEach(item => {
                if(item.u1.bar === val) { found = item; level = 1; }
                else if(item.u2.bar === val) { found = item; level = 2; }
                else if(item.u3.bar === val) { found = item; level = 3; }
                else if(item.u4.bar === val) { found = item; level = 4; }
            });

            if(found) {
                const unitData = found['u' + level];
                cart.push({
                    id: found.kode,
                    nama: found.nama,
                    satuan: unitData.name,
                    harga: unitData.jual,
                    modal_dasar: found.modal1,
                    konv: unitData.konv,
                    poin: unitData.poin,
                    qty: 1
                });
                renderCart();
            }
            document.getElementById('scanInput').value = '';
        }
    }

    function renderCart() {
        const b = document.getElementById('cartBody'); b.innerHTML = '';
        let total = 0;
        cart.forEach((c, i) => {
            total += (c.harga * c.qty);
            b.innerHTML += `<tr><td>${c.nama}</td><td>${c.satuan}</td><td>${c.qty}</td><td>${c.harga.toLocaleString()}</td><td>${(c.harga*c.qty).toLocaleString()}</td><td onclick="cart.splice(${i},1);renderCart()">‚ùå</td></tr>`;
        });
        document.getElementById('totalText').innerText = "Rp " + total.toLocaleString();
    }

    function checkout() {
        if(cart.length === 0) return;
        let profit = 0;
        let totalPoin = 0;
        let itemsStr = [];

        cart.forEach(c => {
            profit += (c.harga - (c.modal_dasar * c.konv)) * c.qty;
            totalPoin += (c.poin * c.qty);
            itemsStr.push(`${c.nama} (${c.qty} ${c.satuan})`);

            // POTONG STOK OTOMATIS BERDASARKAN KONVERSI
            const idx = localDB.findIndex(db => db.kode === c.id);
            if(idx !== -1) {
                localDB[idx].stok_dasar -= (c.qty * c.konv);
            }
        });

        const log = {
            jam: new Date().toLocaleTimeString(),
            tgl: new Date().toISOString().split('T')[0],
            items: itemsStr.join(", "),
            total: cart.reduce((a,b) => a + (b.harga * b.qty), 0),
            profit: profit,
            poin: totalPoin
        };

        history.unshift(log);
        dbRef.ref('v26_master').set(localDB);
        dbRef.ref('v26_history').set(history).then(() => {
            alert("Transaksi Sukses!");
            cart = []; renderCart();
            document.getElementById('payInput').value = '';
        });
    }

    function renderMaster() {
        const b = document.getElementById('masterBody'); b.innerHTML = '';
        localDB.forEach(x => {
            const lowClass = x.stok_dasar <= x.stok_min ? 'status-low' : '';
            b.innerHTML += `<tr>
                <td>${x.kode}</td>
                <td><b>${x.nama}</b></td>
                <td class="${lowClass}">${x.stok_dasar}</td>
                <td>${x.u1.jual} / ${x.u1.name}</td>
                <td>${x.u2.jual || '-'}</td>
                <td>${x.u3.jual || '-'}</td>
                <td>${x.u4.jual || '-'}</td>
                <td><button onclick="alert('Poin L1: ${x.u1.poin}')">Cek Poin</button></td>
            </tr>`;
        });
    }

    function renderReport() {
        const d = document.getElementById('filterDate').value;
        const b = document.getElementById('reportBody'); b.innerHTML = '';
        history.filter(h => h.tgl === d).forEach(h => {
            b.innerHTML += `<tr><td>${h.jam}</td><td>Admin</td><td>${h.items}</td><td>${h.total.toLocaleString()}</td><td>${h.profit.toLocaleString()}</td><td>${h.poin}</td></tr>`;
        });
    }

    function calcChange() {
        const total = parseInt(document.getElementById('totalText').innerText.replace(/\D/g,''));
        const pay = parseInt(document.getElementById('payInput').value) || 0;
        document.getElementById('changeText').innerText = "Kembali: Rp " + (pay - total).toLocaleString();
    }
</script>
</body>
</html>
