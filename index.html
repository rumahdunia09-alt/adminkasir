<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Final System v28</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --g: #6c757d; --bg: #f4f7f6; --dark: #2c3e50; --wa: #25d366; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; }
        
        /* Indikator Koneksi */
        .status-koneksi { position: fixed; top: 10px; right: 10px; font-size: 11px; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10000; border: 1px solid #eee; }
        .lampu { width: 9px; height: 9px; border-radius: 50%; background: #ccc; }
        .online { background: var(--s); box-shadow: 0 0 5px var(--s); }
        .offline { background: var(--d); box-shadow: 0 0 5px var(--d); }

        /* UI Styles */
        .navbar { background: #fff; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; overflow-x: auto; position: sticky; top: 0; z-index: 99; }
        .menu-item { color: rgba(255,255,255,0.7); cursor: pointer; padding: 12px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: var(--p); color: #fff; }

        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        
        input, button, select { padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; }
        .btn-wa { background: var(--wa); } .btn-d { background: var(--d); } .btn-s { background: var(--s); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; }
        th { color: #888; font-size: 12px; text-transform: uppercase; }

        .hidden { display: none !important; }
        .search-container { position: relative; }
        #saranCari { position: absolute; background: white; width: 100%; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 8px; max-height: 200px; overflow-y: auto; }
        .saran-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .saran-item:hover { background: #f0f7ff; }
    </style>
</head>
<body>

    <div class="status-koneksi">
        <div id="lampuIndikator" class="lampu"></div>
        <span id="teksIndikator">Menghubungkan...</span>
    </div>

    <div id="loginPage" style="max-width:400px; margin:100px auto;" class="card">
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="logo.png" style="width:100px" onerror="this.src='https://via.placeholder.com/100?text=IKAMA'">
            <h2>POS SYSTEM</h2>
        </div>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()" style="padding:15px">MASUK</button>
        <p style="font-size: 11px; color: #888; text-align: center;">Gunakan <b>admin</b> / <b>123</b> jika database baru.</p>
    </div>

    <div id="appContainer" class="hidden">
        <div class="navbar">
            <h3 style="margin:0">IKAMAPUSAT <span id="roleBadge" style="font-size:10px; background:#eee; padding:3px 8px; border-radius:10px"></span></h3>
            <div id="displayUser" style="font-weight:bold"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showPage('kasir', this)"><i class="fas fa-shopping-cart"></i> KASIR</div>
            <div class="menu-item" onclick="showPage('laporan', this)"><i class="fas fa-file-invoice-dollar"></i> LAPORAN</div>
            <div class="menu-item adm-only" onclick="showPage('master', this)"><i class="fas fa-boxes"></i> STOK</div>
            <div class="menu-item adm-only" onclick="showPage('karyawan', this)"><i class="fas fa-users"></i> USER</div>
            <div class="menu-item" onclick="location.reload()" style="color:var(--d)"><i class="fas fa-sign-out-alt"></i> KELUAR</div>
        </div>

        <div class="container">
            <div id="page-kasir" class="section">
                <div class="grid">
                    <div class="card" style="flex: 2;">
                        <h3>Keranjang Belanja</h3>
                        <div class="search-container">
                            <input type="text" id="scanKasir" placeholder="Cari nama barang atau barcode..." oninput="cariBarang(this.value)" autocomplete="off">
                            <div id="saranCari" class="hidden"></div>
                        </div>
                        <table>
                            <thead><tr><th>Produk</th><th>Harga</th><th style="width:60px">Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="bodyKeranjang"></tbody>
                        </table>
                    </div>
                    <div class="card" style="flex: 1;">
                        <h3>Pembayaran</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                            <h1 id="totalBelanja" style="text-align:right; font-size:40px; margin:0; color:var(--p)">Rp 0</h1>
                        </div>
                        <input type="number" id="waPelanggan" placeholder="No WhatsApp (628...)">
                        <input type="number" id="uangBayar" placeholder="Uang Bayar (Rp)" oninput="hitungKembalian()" style="font-size:18px; font-weight:bold">
                        <h3 id="textKembalian" style="text-align:right; color:var(--d)">Kembali: Rp 0</h3>
                        <button class="btn-s" onclick="prosesTransaksi(false)" style="margin-bottom:5px">SIMPAN TRANSAKSI</button>
                        <button class="btn-wa" onclick="prosesTransaksi(true)"><i class="fab fa-whatsapp"></i> SIMPAN & KIRIM WA</button>
                    </div>
                </div>
            </div>

            <div id="page-master" class="section hidden adm-only">
                <div class="card" style="border: 2px dashed var(--p); background: #f0f7ff;">
                    <h3>Import Data Excel</h3>
                    <input type="file" id="inpExcel" accept=".xlsx, .xls">
                    <button class="btn-s" onclick="importExcel()" style="width:150px">UNGGAH</button>
                </div>
                <div class="grid">
                    <div class="card">
                        <h3>Tambah Barang</h3>
                        <input type="text" id="m_kode" placeholder="Barcode">
                        <input type="text" id="m_nama" placeholder="Nama Barang">
                        <input type="number" id="m_modal" placeholder="Modal">
                        <input type="number" id="m_harga" placeholder="Jual">
                        <input type="number" id="m_stok" placeholder="Stok">
                        <button class="btn-s" onclick="tambahBarang()">SIMPAN</button>
                    </div>
                    <div class="card">
                        <h3>Stok Inventori</h3>
                        <div style="max-height: 400px; overflow-y:auto">
                            <table id="tblMaster">
                                <thead><tr><th>Nama</th><th>Harga</th><th>Stok</th><th>#</th></tr></thead>
                                <tbody id="bodyMaster"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-laporan" class="section hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center">
                        <h3>Rekap Penjualan</h3>
                        <input type="date" id="filterTgl" onchange="renderLaporan()" style="width:150px">
                    </div>
                    <div class="grid" style="margin: 15px 0">
                        <div style="background:#e8f4fd; padding:15px; border-radius:10px" class="adm-only">
                            <small>Total Omzet</small><br><b id="omzetTgl" style="font-size:20px">Rp 0</b>
                        </div>
                        <div style="background:#eafaf1; padding:15px; border-radius:10px" class="adm-only">
                            <small>Total Profit</small><br><b id="profitTgl" style="font-size:20px; color:var(--s)">Rp 0</b>
                        </div>
                    </div>
                    <table>
                        <thead><tr><th>Jam</th><th>Kasir</th><th>Total</th><th class="adm-only">Profit</th><th>Aksi</th></tr></thead>
                        <tbody id="bodyLaporan"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-karyawan" class="section hidden adm-only">
                <div class="grid">
                    <div class="card">
                        <h3>Tambah Akun</h3>
                        <input type="text" id="k_nama" placeholder="Nama">
                        <input type="text" id="k_user" placeholder="User">
                        <input type="password" id="k_pass" placeholder="Pass">
                        <button class="btn-s" onclick="tambahKaryawan()">SIMPAN</button>
                    </div>
                    <div class="card">
                        <h3>Daftar Pengguna</h3>
                        <table id="bodyKaryawan"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // 1. Konfigurasi Database
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        authDomain: "kasir-ikamapusat.firebaseapp.com",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasir-ikamapusat",
        storageBucket: "kasir-ikamapusat.firebasestorage.app",
        messagingSenderId: "375649394523",
        appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
    };
    firebase.initializeApp(firebaseConfig);
    const dbCloud = firebase.database();
    
    let dbBarang = [], dbRiwayat = [], dbUsers = [], keranjang = [], userLogin = null;
    let isDatabaseReady = false;

    // 2. Indikator Koneksi Realtime
    function setStatus(status) {
        const lampu = document.getElementById('lampuIndikator');
        const teks = document.getElementById('teksIndikator');
        if(status === 'online') {
            lampu.className = 'lampu online';
            teks.innerText = 'Database Ready';
            isDatabaseReady = true;
        } else {
            lampu.className = 'lampu offline';
            teks.innerText = 'Menghubungkan...';
            isDatabaseReady = false;
        }
    }

    // 3. Listener Data Cloud
    dbCloud.ref('v25_users').on('value', snap => {
        dbUsers = snap.val() || [{nama:'Admin Utama', user:'admin', pass:'123', role:'admin'}];
        setStatus('online');
        renderKaryawan();
    }, () => setStatus('offline'));

    dbCloud.ref('v25_barang').on('value', snap => { dbBarang = snap.val() || []; renderMaster(); });
    dbCloud.ref('v25_riwayat').on('value', snap => { dbRiwayat = snap.val() || []; renderLaporan(); });

    // 4. Logika Login
    function doLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        
        // Backup admin lokal jika internet putus saat baru buka
        const listUser = dbUsers.length > 0 ? dbUsers : [{nama:'Admin Utama', user:'admin', pass:'123', role:'admin'}];
        const found = listUser.find(x => x.user === u && x.pass === p);

        if (found) {
            userLogin = found;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('displayUser').innerText = userLogin.nama;
            document.getElementById('roleBadge').innerText = userLogin.role.toUpperCase();
            if(userLogin.role !== 'admin') document.querySelectorAll('.adm-only').forEach(e => e.remove());
            document.getElementById('filterTgl').valueAsDate = new Date();
        } else {
            alert("Username atau Password salah!");
        }
    }

    function showPage(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // 5. Fitur Kasir
    function cariBarang(val) {
        const list = document.getElementById('saranCari');
        if(val.length < 1) { list.classList.add('hidden'); return; }
        const filter = dbBarang.filter(x => x.kode === val || x.nama.toLowerCase().includes(val.toLowerCase())).slice(0, 5);
        if(filter.length > 0) {
            list.innerHTML = filter.map(b => `<div class="saran-item" onclick="pilihBarang('${b.kode}')"><b>${b.nama}</b><br><small>Rp ${b.harga.toLocaleString()} - Stok: ${b.stok}</small></div>`).join('');
            list.classList.remove('hidden');
        } else list.classList.add('hidden');
    }

    function pilihBarang(kode) {
        const b = dbBarang.find(x => x.kode === kode);
        if(b) {
            if(b.stok <= 0) return alert("Stok Habis!");
            const ada = keranjang.find(k => k.kode === b.kode);
            if(ada) ada.qty++; else keranjang.push({...b, qty:1});
            renderKeranjang();
        }
        document.getElementById('scanKasir').value = '';
        document.getElementById('saranCari').classList.add('hidden');
        document.getElementById('scanKasir').focus();
    }

    function renderKeranjang() {
        const b = document.getElementById('bodyKeranjang'); b.innerHTML = '';
        let total = 0;
        keranjang.forEach((k, i) => {
            let sub = k.qty * k.harga; total += sub;
            b.innerHTML += `<tr><td>${k.nama}</td><td>${k.harga.toLocaleString()}</td>
            <td><input type="number" value="${k.qty}" onchange="updateQty(${i}, this.value)" style="width:50px; padding:5px"></td>
            <td>${sub.toLocaleString()}</td><td><button onclick="updateQty(${i},0)" class="btn-d" style="padding:2px 8px">x</button></td></tr>`;
        });
        document.getElementById('totalBelanja').innerText = "Rp " + total.toLocaleString();
        hitungKembalian();
    }

    function updateQty(i, v) { if(v <= 0) keranjang.splice(i,1); else keranjang[i].qty = parseInt(v); renderKeranjang(); }

    function hitungKembalian() {
        const t = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,'')) || 0;
        const b = parseInt(document.getElementById('uangBayar').value) || 0;
        document.getElementById('textKembalian').innerText = "Kembali: Rp " + (b-t < 0 ? 0 : b-t).toLocaleString();
    }

    // 6. Transaksi & WhatsApp
    function prosesTransaksi(pakeWa) {
        const total = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,''));
        const bayar = parseInt(document.getElementById('uangBayar').value) || 0;
        const wa = document.getElementById('waPelanggan').value;

        if(total === 0) return;
        if(bayar < total) return alert("Uang bayar kurang!");
        if(pakeWa && !wa) return alert("Masukkan nomor WhatsApp pelanggan!");

        let profit = 0;
        keranjang.forEach(item => {
            profit += (item.qty * (item.harga - (item.modal || 0)));
            const idx = dbBarang.findIndex(b => b.kode === item.kode);
            if(idx !== -1) dbBarang[idx].stok -= item.qty;
        });

        const sekarang = new Date();
        const nota = {
            tgl: sekarang.toISOString().split('T')[0],
            jam: sekarang.getHours().toString().padStart(2,'0')+":"+sekarang.getMinutes().toString().padStart(2,'0'),
            waktu: sekarang.toLocaleString('id-ID'),
            kasir: userLogin.nama,
            total: total,
            profit: profit,
            items: [...keranjang]
        };

        dbRiwayat.unshift(nota);
        dbCloud.ref('v25_barang').set(dbBarang);
        dbCloud.ref('v25_riwayat').set(dbRiwayat).then(() => {
            if(pakeWa) kirimWA(wa, nota);
            alert("Transaksi Berhasil!");
            keranjang = []; renderKeranjang();
            document.getElementById('uangBayar').value = '';
            document.getElementById('waPelanggan').value = '';
        });
    }

    function kirimWA(no, nota) {
        let n = no.startsWith('0') ? '62' + no.slice(1) : no;
        let teks = `*IKAMAPUSAT NOTA*%0A${nota.waktu}%0A----------------------%0A`;
        nota.items.forEach(it => teks += `${it.nama} x${it.qty} = Rp ${(it.qty*it.harga).toLocaleString()}%0A`);
        teks += `----------------------%0A*TOTAL: Rp ${nota.total.toLocaleString()}*%0A%0A_Terima Kasih!_`;
        window.open(`https://wa.me/${n}?text=${teks}`, '_blank');
    }

    // 7. Fitur Master & Laporan
    function renderMaster() {
        const b = document.getElementById('bodyMaster'); b.innerHTML = '';
        dbBarang.forEach((brg, i) => {
            b.innerHTML += `<tr><td>${brg.nama}</td><td>${brg.harga.toLocaleString()}</td>
            <td><b style="color:${brg.stok < 5 ? 'red' : 'green'}">${brg.stok}</b></td>
            <td><button onclick="hapusBarang(${i})" class="btn-d" style="padding:2px 8px">x</button></td></tr>`;
        });
    }

    function tambahBarang() {
        const k=document.getElementById('m_kode'), n=document.getElementById('m_nama'), mod=document.getElementById('m_modal'), h=document.getElementById('m_harga'), s=document.getElementById('m_stok');
        dbBarang.push({kode:k.value, nama:n.value, modal:parseInt(mod.value)||0, harga:parseInt(h.value)||0, stok:parseInt(s.value)||0});
        dbCloud.ref('v25_barang').set(dbBarang).then(() => [k,n,mod,h,s].forEach(i=>i.value=''));
    }

    function hapusBarang(i) { if(confirm("Hapus barang?")) { dbBarang.splice(i,1); dbCloud.ref('v25_barang').set(dbBarang); } }

    function renderLaporan() {
        const tgl = document.getElementById('filterTgl').value;
        const b = document.getElementById('bodyLaporan'); b.innerHTML = '';
        let omzet = 0, profit = 0;
        dbRiwayat.filter(r => r.tgl === tgl).forEach((r, i) => {
            omzet += r.total; profit += r.profit;
            b.innerHTML += `<tr><td>${r.jam}</td><td>${r.kasir}</td><td>${r.total.toLocaleString()}</td>
            <td class="adm-only">${r.profit.toLocaleString()}</td>
            <td><button onclick="hapusLaporan(${i})" class="btn-d" style="padding:2px 8px">x</button></td></tr>`;
        });
        if(userLogin && userLogin.role==='admin') {
            document.getElementById('omzetTgl').innerText = "Rp " + omzet.toLocaleString();
            document.getElementById('profitTgl').innerText = "Rp " + profit.toLocaleString();
        }
    }

    function hapusLaporan(i) { if(confirm("Hapus riwayat?")) { dbRiwayat.splice(i,1); dbCloud.ref('v25_riwayat').set(dbRiwayat); } }

    function renderKaryawan() {
        const b = document.getElementById('bodyKaryawan'); if(!b) return;
        b.innerHTML = dbUsers.map((u, i) => `<tr><td>${u.nama} (${u.role})</td><td>${u.role==='admin'?'-':`<button onclick="hapusUser(${i})" class="btn-d">Hapus</button>`}</td></tr>`).join('');
    }

    function tambahKaryawan() {
        const n=document.getElementById('k_nama'), u=document.getElementById('k_user'), p=document.getElementById('k_pass');
        dbUsers.push({nama:n.value, user:u.value, pass:p.value, role:'kasir'});
        dbCloud.ref('v25_users').set(dbUsers).then(() => [n,u,p].forEach(i=>i.value=''));
    }

    function hapusUser(i) { if(confirm("Hapus user?")) { dbUsers.splice(i,1); dbCloud.ref('v25_users').set(dbUsers); } }

    function importExcel() {
        const file = document.getElementById('inpExcel').files[0];
        if(!file) return alert("Pilih file!");
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            rows.forEach(r => {
                dbBarang.push({
                    kode: String(r.Kode || r.Barcode || ''), nama: String(r.Nama || ''),
                    modal: parseInt(r.Modal) || 0, harga: parseInt(r.Harga || r.Jual) || 0, stok: parseInt(r.Stok) || 0
                });
            });
            dbCloud.ref('v25_barang').set(dbBarang).then(() => alert("Import Berhasil!"));
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
