<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Final System v25.5</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --g: #6c757d; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); min-height: 100vh; }
        
        /* Layout & UI */
        .navbar { background: #fff; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 10px 25px; display: flex; gap: 10px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 10px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { background: var(--p); }
        .container { padding: 20px; max-width: 1300px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Form & Table */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, button, select { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        
        /* Modal Style */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 25px; width: 400px; border-radius: 12px; }

        .hidden { display: none !important; }
        .btn-edit { background: #ffc107; color: black; padding: 5px 10px; margin-right: 5px; }
        .btn-d { background: var(--d); padding: 5px 10px; }
        .btn-s { background: var(--s); }
    </style>
</head>
<body>

    <div id="modalEdit" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-edit"></i> Edit Barang</h3>
            <input type="hidden" id="edit_index">
            <label>Barcode:</label><input type="text" id="edit_kode">
            <label>Nama Barang:</label><input type="text" id="edit_nama">
            <label>Harga Modal:</label><input type="number" id="edit_modal">
            <label>Harga Jual:</label><input type="number" id="edit_harga">
            <label>Stok:</label><input type="number" id="edit_stok">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-s" onclick="simpanPerubahan()">SIMPAN</button>
                <button style="background:var(--g)" onclick="closeModal()">BATAL</button>
            </div>
        </div>
    </div>

    <div id="loginPage" style="max-width:400px; margin:80px auto; text-align: center;" class="card">
        <h2>IKAMAPUSAT LOGIN</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()">MASUK</button>
    </div>

    <div id="appContainer" class="hidden">
        <div class="navbar">
            <h3>IKAMAPUSAT <span id="roleBadge" style="font-size:10px; background:#eee; padding:2px 6px;"></span></h3>
            <div id="displayUser"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showPage('kasir', this)"><i class="fas fa-shopping-cart"></i> Kasir</div>
            <div class="menu-item" onclick="showPage('ppob', this)"><i class="fas fa-mobile-alt"></i> PPOB</div>
            <div class="menu-item" onclick="showPage('laporan', this)"><i class="fas fa-file-invoice-dollar"></i> Laporan</div>
            <div class="menu-item adm-only" onclick="showPage('master', this)"><i class="fas fa-boxes"></i> Master & Edit</div>
            <div class="menu-item" onclick="location.reload()" style="background:var(--d)">Keluar</div>
        </div>

        <div class="container">
            <div id="page-kasir" class="section">
                <div class="grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="card">
                        <input type="text" id="scanKasir" placeholder="Scan Barcode / Cari Nama..." onkeypress="handleKasirScan(event)" autofocus>
                        <table>
                            <thead><tr><th>Barang</th><th>Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="bodyKeranjang"></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h1 id="totalBelanja" style="text-align:right; color:var(--p)">Rp 0</h1>
                        <input type="number" id="uangBayar" placeholder="Bayar (Rp)" oninput="hitungKembalian()">
                        <h3 id="textKembalian" style="text-align:right; color:var(--d)">Kembali: Rp 0</h3>
                        <button class="btn-s" onclick="prosesTransaksi()">SIMPAN TRANSAKSI</button>
                    </div>
                </div>
            </div>

            <div id="page-master" class="section hidden adm-only">
                <div class="card">
                    <h3>Tambah Barang</h3>
                    <div class="grid">
                        <input type="text" id="m_kode" placeholder="Barcode">
                        <input type="text" id="m_nama" placeholder="Nama">
                        <input type="number" id="m_modal" placeholder="Modal">
                        <input type="number" id="m_harga" placeholder="Jual">
                        <input type="number" id="m_stok" placeholder="Stok">
                    </div>
                    <button class="btn-s" onclick="tambahBarang()">TAMBAH KE DATABASE</button>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 15px;">
                        <h3>Daftar Barang & Inventori</h3>
                        <input type="text" id="cariMaster" placeholder="Cari..." oninput="renderMaster()" style="width:200px">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Nama Barang</th>
                                <th>Modal</th>
                                <th>Jual</th>
                                <th>Stok</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMaster"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-laporan" class="section hidden">
                <div class="card">
                    <h3>Laporan Pendapatan</h3>
                    <input type="date" id="filterTgl" onchange="renderLaporan()" style="width: auto;">
                    <table>
                        <thead><tr><th>Jam</th><th>Kasir</th><th>Item</th><th>Total</th><th class="adm-only">Profit</th></tr></thead>
                        <tbody id="bodyLaporan"></tbody>
                        <tfoot id="footLaporan"></tfoot>
                    </table>
                </div>
            </div>
            
            <div id="page-ppob" class="section hidden">
                <div class="card">
                    <h3>Transaksi Digital</h3>
                    <div class="grid">
                        <select id="p_layanan" onchange="updatePlaceholderPPOB()">
                            <option value="PULSA">PULSA</option>
                            <option value="TOKEN LISTRIK">TOKEN LISTRIK</option>
                        </select>
                        <input type="text" id="p_tujuan" placeholder="Nomor HP">
                        <input type="text" id="p_sn" placeholder="SN/Token (Khusus Listrik)">
                        <input type="number" id="p_harga"
