<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Universal POS v15</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sidebar-w: 240px; --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg); display: flex; }
        
        /* Sidebar */
        #sidebar { width: var(--sidebar-w); background: var(--primary); height: 100vh; color: white; position: fixed; display: none; z-index: 100; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #bdc3c7; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: white; }

        /* Main Content */
        #main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); display: none; min-height: 100vh; }
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .content { padding: 25px; }
        .page { display: none; }
        .page.active { display: block; }

        /* UI */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, button { padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        
        #loginPage { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2>IKAMAPUSAT</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="doLogin()">LOGIN</button>
            <p id="msg" style="color:red; font-size:12px"></p>
        </div>
    </div>

    <div id="sidebar">
        <div style="padding:25px; font-weight:bold; border-bottom:1px solid #34495e;">ADMIN PANEL</div>
        <nav>
            <div class="nav-item active" onclick="showPage('dash', this)"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="showPage('kasir', this)"><i class="fas fa-cash-register"></i> Kasir</div>
            <div class="nav-item" onclick="showPage('master', this)"><i class="fas fa-box"></i> Master Barang</div>
            <div class="nav-item" onclick="showPage('riwayat', this)"><i class="fas fa-history"></i> Riwayat Transaksi</div>
        </nav>
    </div>

    <div id="main">
        <header>
            <div id="titlePage" style="font-weight:bold">DASHBOARD</div>
            <button onclick="location.reload()" style="width:auto; background:#e74c3c">Keluar</button>
        </header>
        <div class="content">
            <div id="dashPage" class="page active">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px">
                    <div class="card" style="background:#3498db; color:white">Total Barang <h2 id="stokCount">0</h2></div>
                    <div class="card" style="background:#2ecc71; color:white">Transaksi Hari Ini <h2 id="trxCount">0</h2></div>
                </div>
            </div>

            <div id="kasirPage" class="page">
                <div class="card">
                    <input type="text" id="scanKasir" placeholder="Scan/Cari Barang..." onkeypress="handleScan(event)">
                    <table id="cartTable">
                        <thead><tr><th>Produk</th><th>Qty</th><th>Subtotal</th></tr></thead>
                        <tbody id="cartBody"></tbody>
                    </table>
                    <h2 id="totalBayar">Total: Rp 0</h2>
                    <button onclick="bayarSekarang()" style="background:#2ecc71">PROSES BAYAR</button>
                </div>
            </div>

            <div id="masterPage" class="page">
                <div class="card">
                    <h3>Tambah Barang</h3>
                    <input type="text" id="m_kode" placeholder="Barcode">
                    <input type="text" id="m_nama" placeholder="Nama Barang">
                    <input type="number" id="m_harga" placeholder="Harga Jual">
                    <input type="number" id="m_stok" placeholder="Stok">
                    <button onclick="simpanBarang()">SIMPAN KE DATABASE</button>
                </div>
                <div class="card">
                    <table id="masterTable">
                        <thead><tr><th>Kode</th><th>Nama</th><th>Harga</th><th>Stok</th></tr></thead>
                        <tbody id="masterBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="riwayatPage" class="page">
                <div class="card">
                    <h3>Riwayat Transaksi</h3>
                    <table id="riwayatTable">
                        <thead><tr><th>Waktu</th><th>Total</th><th>Kasir</th></tr></thead>
                        <tbody id="riwayatBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
            authDomain: "kasir-ikamapusat.firebaseapp.com",
            databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kasir-ikamapusat",
            storageBucket: "kasir-ikamapusat.firebasestorage.app",
            messagingSenderId: "375649394523",
            appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dataBarang = [];
        let dataRiwayat = [];
        let keranjang = [];

        // LOAD DATA - Mengacu pada folder v13 agar data lama muncul
        db.ref('v13_barang').on('value', snap => {
            dataBarang = snap.val() || [];
            renderMaster();
            document.getElementById('stokCount').innerText = dataBarang.length;
        });

        db.ref('v13_riwayat').on('value', snap => {
            dataRiwayat = snap.val() || [];
            renderRiwayat();
            document.getElementById('trxCount').innerText = dataRiwayat.length;
        });

        function doLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === '123') {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('main').style.display = 'block';
            } else {
                document.getElementById('msg').innerText = "Login Gagal! Gunakan admin / 123";
            }
        }

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            el.classList.add('active');
        }

        function renderMaster() {
            const body = document.getElementById('masterBody');
            body.innerHTML = '';
            dataBarang.forEach(b => {
                body.innerHTML += `<tr><td>${b.kode}</td><td>${b.nama}</td><td>${b.harga}</td><td>${b.stok}</td></tr>`;
            });
        }

        function renderRiwayat() {
            const body = document.getElementById('riwayatBody');
            body.innerHTML = '';
            dataRiwayat.forEach(r => {
                body.innerHTML += `<tr><td>${r.waktu}</td><td>Rp ${r.total.toLocaleString()}</td><td>${r.kasir || 'Admin'}</td></tr>`;
            });
        }

        function handleScan(e) {
            if(e.key === 'Enter') {
                const b = dataBarang.find(x => x.kode === scanKasir.value);
                if(b) {
                    keranjang.push({...b, qty:1});
                    renderCart();
                }
                scanKasir.value = '';
            }
        }

        function renderCart() {
            const body = document.getElementById('cartBody');
            body.innerHTML = ''; let t = 0;
            keranjang.forEach(k => {
                let sub = k.qty * k.harga; t += sub;
                body.innerHTML += `<tr><td>${k.nama}</td><td>${k.qty}</td><td>${sub}</td></tr>`;
            });
            document.getElementById('totalBayar').innerText = "Total: Rp " + t.toLocaleString();
        }

        function simpanBarang() {
            const b = {
                kode: document.getElementById('m_kode').value,
                nama: document.getElementById('m_nama').value,
                harga: parseInt(document.getElementById('m_harga').value),
                stok: parseInt(document.getElementById('m_stok').value)
            };
            dataBarang.push(b);
            db.ref('v13_barang').set(dataBarang);
            alert("Barang Disimpan!");
        }

        function bayarSekarang() {
            const total = parseInt(document.getElementById('totalBayar').innerText.replace(/\D/g,''));
            const trx = { waktu: new Date().toLocaleString(), total: total, kasir: 'Admin' };
            dataRiwayat.unshift(trx);
            db.ref('v13_riwayat').set(dataRiwayat);
            alert("Pembayaran Berhasil!");
            keranjang = []; renderCart();
        }
    </script>
</body>
</html>
