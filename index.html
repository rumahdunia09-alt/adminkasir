<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.0 - Final System</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); }
        .navbar { background: white; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; }
        .menu-item { color: #fff; cursor: pointer; padding: 12px 18px; border-radius: 5px; font-size: 13px; }
        .menu-item.active { background: var(--p); }
        .container { padding: 20px; max-width: 1400px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        button { cursor: pointer; padding: 10px; border-radius: 8px; border: none; font-weight: bold; color: white; transition: 0.3s; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; }
        .hidden { display: none !important; }
        .btn-download { background: #6f42c1; margin-bottom: 10px; }
        .btn-import { background: var(--s); }
        .btn-clear { background: var(--d); }
    </style>
</head>
<body>

    <div class="navbar">
        <h3 style="margin:0">IKAMA <span style="color:var(--p)">v26.0</span></h3>
        <div id="userDisplay">Admin Mode</div>
    </div>

    <div class="menu-bar">
        <div class="menu-item active" onclick="showPage('kasir', this)">Kasir</div>
        <div class="menu-item" onclick="showPage('master', this)">Master & Database</div>
    </div>

    <div class="container">
        <div id="page-master" class="section hidden">
            <div class="card">
                <h3><i class="fas fa-database"></i> Manajemen Database</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-download" onclick="downloadTemplate()">
                        <i class="fas fa-file-download"></i> 1. DOWNLOAD TEMPLATE EXCEL
                    </button>
                    
                    <div style="border-left: 1px solid #ddd; padding-left: 10px;">
                        <input type="file" id="xlFile" accept=".xlsx, .xls">
                        <button class="btn-import" onclick="importExcel()">
                            <i class="fas fa-file-upload"></i> 2. UPLOAD DATA
                        </button>
                    </div>

                    <button class="btn-clear" onclick="clearDB()">
                        <i class="fas fa-trash"></i> KOSONGKAN SEMUA
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>Daftar Inventori</h3>
                <table>
                    <thead>
                        <tr>
                            <th>NAMA ITEM</th><th>STOK</th><th>L1 (PCS)</th><th>L2 (RTG)</th><th>L3 (BOX)</th><th>L4 (DUS)</th><th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="masterBody"></tbody>
                </table>
            </div>
        </div>

        <div id="page-kasir" class="section">
            <div class="card">
                <input type="text" id="scan" placeholder="Scan Barcode Satuan Apapun..." style="width:100%; padding:15px; font-size:18px; border: 2px solid var(--p); border-radius: 10px;" onkeypress="handleScan(event)">
                <table style="margin-top:20px">
                    <thead><tr><th>Produk</th><th>Satuan</th><th>Harga</th><th>Qty</th><th>Total</th></tr></thead>
                    <tbody id="cartBody"></tbody>
                </table>
                <h1 id="totalHarga" style="text-align:right; font-size:40px; color:var(--p)">Rp 0</h1>
            </div>
        </div>
    </div>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dbBarang = [];

    // Sync Data
    db.ref('v26_master').on('value', s => { 
        dbBarang = s.val() || []; 
        renderMaster(); 
    });

    function showPage(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // --- FITUR DOWNLOAD TEMPLATE ---
    function downloadTemplate() {
        const header = [
            ["KODE ITEM", "NAMA ITEM", "STOK AWAL SATUAN DASAR", "HARGA POKOK SATUAN 1", 
             "SATUAN 1", "BARCODE SATUAN 1", "HARGA JUAL SATUAN 1", 
             "SATUAN 2", "BARCODE SATUAN 2", "KONVERSI SATUAN 2", "HARGA JUAL SATUAN 2", 
             "SATUAN 3", "BARCODE SATUAN 3", "KONVERSI I SATUAN 3", "HARGA JUAL SATUAN 3", 
             "SATUAN 4", "BARCODE SATUAN 4", "KONVERSI SATUAN 4", "HARGA JUAL SATUAN 4"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(header);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Template");
        XLSX.writeFile(wb, "Template_IKAMA_v26.xlsx");
    }

    // --- FITUR IMPORT EXCEL ---
    function importExcel() {
        const file = document.getElementById('xlFile').files[0];
        if(!file) return alert("Pilih file hasil download template!");
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            let dataFix = [];
            data.forEach(r => {
                if(r["NAMA ITEM"]) {
                    dataFix.push({
                        kode: String(r["KODE ITEM"] || r["BARCODE SATUAN 1"]),
                        nama: r["NAMA ITEM"],
                        stok: parseInt(r["STOK AWAL SATUAN DASAR"]) || 0,
                        hpp: parseInt(r["HARGA POKOK SATUAN 1"]) || 0,
                        u1: { name: r["SATUAN 1"]||"PCS", bar: String(r["BARCODE SATUAN 1"]||""), jual: parseInt(r["HARGA JUAL SATUAN 1"])||0, konv: 1 },
                        u2: { name: r["SATUAN 2"]||"", bar: String(r["BARCODE SATUAN 2"]||""), jual: parseInt(r["HARGA JUAL SATUAN 2"])||0, konv: parseInt(r["KONVERSI SATUAN 2"])||0 },
                        u3: { name: r["SATUAN 3"]||"", bar: String(r["BARCODE SATUAN 3"]||""), jual: parseInt(r["HARGA JUAL SATUAN 3"])||0, konv: parseInt(r["KONVERSI I SATUAN 3"])||0 },
                        u4: { name: r["SATUAN 4"]||"", bar: String(r["BARCODE SATUAN 4"]||""), jual: parseInt(r["HARGA JUAL SATUAN 4"])||0, konv: parseInt(r["KONVERSI SATUAN 4"])||0 }
                    });
                }
            });
            db.ref('v26_master').set(dataFix).then(() => alert("Berhasil Sinkron! Total: " + dataFix.length));
        };
        reader.readAsArrayBuffer(file);
    }

    function renderMaster() {
        const b = document.getElementById('masterBody'); b.innerHTML = '';
        dbBarang.forEach((x, i) => {
            b.innerHTML += `<tr>
                <td><b>${x.nama}</b></td><td>${x.stok}</td>
                <td>${x.u1.jual.toLocaleString()}</td><td>${x.u2.jual.toLocaleString()}</td>
                <td>${x.u3.jual.toLocaleString()}</td><td>${x.u4.jual.toLocaleString()}</td>
                <td><button style="background:var(--d)" onclick="delItem(${i})">Hapus</button></td>
            </tr>`;
        });
    }

    function clearDB() { if(confirm("Hapus semua data?")) db.ref('v26_master').set(null); }
    function delItem(i) { dbBarang.splice(i, 1); db.ref('v26_master').set(dbBarang); }

    function handleScan(e) {
        if(e.key === 'Enter') {
            const v = e.target.value;
            let found = null, lv = 1;
            dbBarang.forEach(b => {
                if(b.u1.bar === v) { found=b; lv=1; }
                else if(b.u2.bar === v) { found=b; lv=2; }
                else if(b.u3.bar === v) { found=b; lv=3; }
                else if(b.u4.bar === v) { found=b; lv=4; }
            });
            if(found) {
                const u = found['u'+lv];
                alert("Scan Berhasil: " + found.nama + " (" + u.name + ")");
            }
            e.target.value = '';
        }
    }
</script>
</body>
</html>
