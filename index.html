<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Pro POS v14</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sidebar-w: 240px; --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; background: var(--bg); display: flex; }
        
        /* Login Page */
        #loginPage { position: fixed; inset: 0; background: #2c3e50; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Sidebar & Layout */
        #sidebar { width: var(--sidebar-w); background: var(--primary); height: 100vh; color: white; position: fixed; display: none; }
        #main { margin-left: var(--sidebar-w); width: calc(100% - var(--sidebar-w)); display: none; min-height: 100vh; }
        
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #bdc3c7; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: white; }
        
        header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .content { padding: 25px; }
        .page { display: none; }
        .page.active { display: block; }

        /* UI Elements */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, button { padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        .admin-only { display: none; }
    </style>
</head>
<body>

    <div id="loginPage">
        <div class="login-card">
            <h2 style="margin-top:0">IKAMAPUSAT</h2>
            <p style="font-size: 12px; color: #666;">Silakan masuk ke akun Anda</p>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="doLogin()" id="btnLogin">MASUK SEKARANG</button>
            <div id="loginMsg" style="color: red; font-size: 12px; margin-top: 10px;"></div>
        </div>
    </div>

    <div id="sidebar">
        <div style="padding: 25px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #34495e;">POS SYSTEM</div>
        <nav style="margin-top: 20px;">
            <div class="nav-item active" onclick="showPage('dash', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="showPage('kasir', this)"><i class="fas fa-shopping-cart"></i> Kasir</div>
            <div class="nav-item admin-only" onclick="showPage('master', this)"><i class="fas fa-box"></i> Master Barang</div>
            <div class="nav-item" onclick="showPage('laporan', this)"><i class="fas fa-history"></i> Riwayat</div>
            <div class="nav-item admin-only" onclick="showPage('users', this)"><i class="fas fa-user-cog"></i> Pengguna</div>
        </nav>
    </div>

    <div id="main">
        <header>
            <div id="titlePage" style="font-weight: bold; color: var(--primary);">DASHBOARD</div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="userStatus" style="font-size: 14px; font-weight: bold;"></span>
                <button onclick="location.reload()" style="width: auto; background: #e74c3c; padding: 5px 15px;">Keluar</button>
            </div>
        </header>

        <div class="content">
            <div id="dashPage" class="page active">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div class="card" style="background: #3498db; color: white;">Omzet Hari Ini<h2 id="dashOmzet">Rp 0</h2></div>
                    <div class="card" style="background: #2ecc71; color: white;">Profit Hari Ini<h2 id="dashProfit">Rp 0</h2></div>
                    <div class="card" style="background: #f1c40f; color: white;">Transaksi<h2 id="dashTrx">0</h2></div>
                </div>
            </div>

            <div id="kasirPage" class="page">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div class="card">
                        <input type="text" id="scanKasir" placeholder="Scan Barcode atau Ketik Nama Barang..." onkeypress="handleScan(event)">
                        <table>
                            <thead><tr><th>Produk</th><th>Qty</th><th>Subtotal</th></tr></thead>
                            <tbody id="bodyKeranjang"></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h2 id="total" style="color: var(--accent); margin-top: 0;">Rp 0</h2>
                        <select id="metode"><option>Tunai</option><option>QRIS/DANA</option></select>
                        <input type="number" id="bayar" placeholder="Uang Bayar" oninput="hitungKemb()">
                        <h3 id="kembali" style="color: #e74c3c;">Kembali: 0</h3>
                        <button style="background: #2ecc71; padding: 15px;" onclick="prosesJual()">SIMPAN & CETAK</button>
                    </div>
                </div>
            </div>

            <div id="usersPage" class="page">
                <div class="card">
                    <h3>Tambah User Baru</h3>
                    <input type="text" id="uNama" placeholder="Nama Lengkap">
                    <input type="text" id="uUser" placeholder="Username">
                    <input type="text" id="uPass" placeholder="Password">
                    <select id="uRole"><option value="kasir">Kasir</option><option value="admin">Admin</option></select>
                    <button onclick="tambahUser()">SIMPAN USER</button>
                </div>
                <div class="card">
                    <table><thead><tr><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead><tbody id="listUsers"></tbody></table>
                </div>
            </div>
            
            </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
            authDomain: "kasir-ikamapusat.firebaseapp.com",
            databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kasir-ikamapusat",
            storageBucket: "kasir-ikamapusat.firebasestorage.app",
            messagingSenderId: "375649394523",
            appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let dbUsers = [];
        let dbBarang = [];
        let dbRiwayat = [];
        let keranjang = [];

        // LOAD USERS FROM FIREBASE
        db.ref('v14_users').on('value', snap => {
            dbUsers = snap.val() || [];
        });

        function doLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const msg = document.getElementById('loginMsg');

            // 1. CEK KUNCI DARURAT (Selalu Aktif)
            if (u === 'admin' && p === '123') {
                loginSuccess({nama: 'Super Admin', role: 'admin'});
                return;
            }

            // 2. CEK DATABASE FIREBASE
            const user = dbUsers.find(x => x.user === u && x.pass === p);
            if (user) {
                loginSuccess(user);
            } else {
                msg.innerText = "Username atau Password Salah!";
            }
        }

        function loginSuccess(user) {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('main').style.display = 'block';
            document.getElementById('userStatus').innerText = user.nama;
            
            if (user.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'flex');
            }
        }

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id + 'Page').classList.add('active');
            el.classList.add('active');
            document.getElementById('titlePage').innerText = id.toUpperCase();
        }

        // --- KASIR LOGIC ---
        db.ref('v14_barang').on('value', snap => { dbBarang = snap.val() || []; });
        
        function handleScan(e) {
            if(e.key === 'Enter') {
                const b = dbBarang.find(x => x.kode === scanKasir.value || x.nama.toLowerCase().includes(scanKasir.value.toLowerCase()));
                if(b && b.stok > 0) {
                    const ada = keranjang.find(k => k.kode === b.kode);
                    if(ada) ada.qty++; else keranjang.push({...b, qty: 1});
                    renderKeranjang();
                }
                scanKasir.value = '';
            }
        }

        function renderKeranjang() {
            bodyKeranjang.innerHTML = ''; let t = 0;
            keranjang.forEach((k, i) => {
                let sub = k.qty * k.harga; t += sub;
                bodyKeranjang.innerHTML += `<tr><td>${k.nama}</td><td>${k.qty}</td><td>Rp ${sub.toLocaleString()}</td></tr>`;
            });
            total.innerText = "Rp " + t.toLocaleString();
        }

        function hitungKemb() {
            const t = parseInt(total.innerText.replace(/\D/g,''));
            const b = parseInt(bayar.value) || 0;
            kembali.innerText = "Kembali: Rp " + (b - t).toLocaleString();
        }

        function tambahUser() {
            const newUser = {
                nama: document.getElementById('uNama').value,
                user: document.getElementById('uUser').value,
                pass: document.getElementById('uPass').value,
                role: document.getElementById('uRole').value
            };
            dbUsers.push(newUser);
            db.ref('v14_users').set(dbUsers);
            alert("User Berhasil Disimpan!");
        }
    </script>
</body>
</html>
