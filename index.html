<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.0 - Multi-Unit System</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --g: #6c757d; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: #333; }
        .navbar { background: #fff; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 10px 25px; display: flex; gap: 10px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 10px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { background: var(--p); }
        .container { padding: 20px; max-width: 1300px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, button, select { padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f9fa; }
        .hidden { display: none !important; }
        .unit-box { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    </style>
</head>
<body>

    <div id="loginPage" style="max-width:400px; margin:100px auto; text-align: center;" class="card">
        <h1 style="color:var(--p)">IKAMAPUSAT v26</h1>
        <p>Sistem Kasir Konversi Satuan</p>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()">MASUK</button>
    </div>

    <div id="appContainer" class="hidden">
        <div class="navbar">
            <h3>IKAMA <span id="roleBadge" class="badge" style="background:#eee"></span></h3>
            <div id="displayUser" style="font-weight:bold"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showPage('kasir', this)"><i class="fas fa-shopping-cart"></i> Kasir</div>
            <div class="menu-item adm-only" onclick="showPage('master', this)"><i class="fas fa-boxes"></i> Master Barang</div>
            <div class="menu-item" onclick="showPage('laporan', this)"><i class="fas fa-file-invoice-dollar"></i> Laporan</div>
            <div class="menu-item" onclick="location.reload()" style="background:var(--d)">Keluar</div>
        </div>

        <div class="container">
            <div id="page-kasir" class="section">
                <div class="grid" style="grid-template-columns: 1.5fr 1fr;">
                    <div class="card">
                        <input type="text" id="scanKasir" placeholder="Scan Barcode Satuan Apapun..." onkeypress="handleKasirScan(event)" autofocus style="font-size: 18px; border: 2px solid var(--p)">
                        <table>
                            <thead><tr><th>Item</th><th>Satuan</th><th>Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="bodyKeranjang"></tbody>
                        </table>
                    </div>
                    <div class="card" style="text-align: right;">
                        <h1 id="totalBelanja" style="font-size:50px; color:var(--p); margin:0">Rp 0</h1>
                        <input type="number" id="uangBayar" placeholder="Bayar Tunai..." oninput="hitungKembalian()" style="font-size:25px; text-align:right">
                        <h3 id="textKembalian">Kembali: Rp 0</h3>
                        <button onclick="prosesTransaksi()" style="padding:20px; font-size:20px; background:var(--s)">BAYAR SEKARANG</button>
                    </div>
                </div>
            </div>

            <div id="page-master" class="section hidden adm-only">
                <div class="card">
                    <h3>Input Master Barang (Multi-Satuan)</h3>
                    <div class="grid" style="grid-template-columns: 2fr 1fr 1fr;">
                        <input type="text" id="m_nama" placeholder="Nama Barang (Cth: Sajiku Bakwan)">
                        <input type="text" id="m_jenis" placeholder="Jenis (MKN/SABUN)">
                        <input type="text" id="m_merek" placeholder="Merek">
                    </div>
                    <div class="grid" style="margin-top:15px">
                        <div class="unit-box">
                            <strong>Level 1 (Terpendek)</strong>
                            <input type="text" id="m_sat1" placeholder="Nama (PCS)" value="PCS">
                            <input type="text" id="m_bar1" placeholder="Barcode PCS">
                            <input type="number" id="m_mod1" placeholder="Modal Satuan 1">
                            <input type="number" id="m_jual1" placeholder="Jual Satuan 1">
                        </div>
                        <div class="unit-box">
                            <strong>Level 2 (Menengah)</strong>
                            <input type="text" id="m_sat2" placeholder="Nama (RTG)">
                            <input type="text" id="m_bar2" placeholder="Barcode RTG">
                            <input type="number" id="m_konv2" placeholder="Isi (Berapa PCS?)">
                            <input type="number" id="m_jual2" placeholder="Jual Satuan 2">
                        </div>
                        <div class="unit-box">
                            <strong>Level 3 (Besar)</strong>
                            <input type="text" id="m_sat3" placeholder="Nama (DUS)">
                            <input type="text" id="m_bar3" placeholder="Barcode DUS">
                            <input type="number" id="m_konv3" placeholder="Isi (Berapa PCS?)">
                            <input type="number" id="m_jual3" placeholder="Jual Satuan 3">
                        </div>
                    </div>
                    <button onclick="tambahBarang()" style="margin-top:15px; background:var(--s)">SIMPAN KE DATABASE</button>
                </div>

                <div class="card">
                    <h3>Data Inventori (Stok dlm Satuan Terkecil)</h3>
                    <input type="text" id="cariMaster" placeholder="Cari..." oninput="renderMaster()">
                    <table style="margin-top:10px">
                        <thead>
                            <tr><th>Nama Barang</th><th>Stok Dasar</th><th>Harga (L1/L2/L3)</th><th>Aksi</th></tr>
                        </thead>
                        <tbody id="bodyMaster"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-laporan" class="section hidden">
                <div class="card">
                    <h3>Laporan Penjualan</h3>
                    <input type="date" id="filterTgl" onchange="renderLaporan()">
                    <table id="tabelLaporan">
                        <thead><tr><th>Jam</th><th>Item</th><th>Total Jual</th><th>Profit</th></tr></thead>
                        <tbody id="bodyLaporan"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIG & DB ---
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let dbBarang = [], dbRiwayat = [], userLogin = null;
    const users = [{user:'admin', pass:'123', role:'admin', nama:'Owner Ikama'}];

    // --- SYNC DATA ---
    db.ref('v26_barang').on('value', s => { dbBarang = s.val() || []; renderMaster(); });
    db.ref('v26_riwayat').on('value', s => { dbRiwayat = s.val() || []; renderLaporan(); });

    // --- AUTH ---
    function doLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const found = users.find(x => x.user === u && x.pass === p);
        if(found) {
            userLogin = found;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('displayUser').innerText = found.nama;
            document.getElementById('roleBadge').innerText = found.role.toUpperCase();
        } else alert("Login Gagal!");
    }

    function showPage(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // --- CORE LOGIC: MULTI SATUAN ---
    function tambahBarang() {
        const item = {
            nama: document.getElementById('m_nama').value,
            jenis: document.getElementById('m_jenis').value,
            merek: document.getElementById('m_merek').value,
            stok: 0,
            // Satuan 1 (Dasar)
            sat1: document.getElementById('m_sat1').value,
            bar1: document.getElementById('m_bar1').value,
            mod1: parseInt(document.getElementById('m_mod1').value) || 0,
            jual1: parseInt(document.getElementById('m_jual1').value) || 0,
            // Satuan 2
            sat2: document.getElementById('m_sat2').value,
            bar2: document.getElementById('m_bar2').value,
            konv2: parseInt(document.getElementById('m_konv2').value) || 1,
            jual2: parseInt(document.getElementById('m_jual2').value) || 0,
            // Satuan 3
            sat3: document.getElementById('m_sat3').value,
            bar3: document.getElementById('m_bar3').value,
            konv3: parseInt(document.getElementById('m_konv3').value) || 1,
            jual3: parseInt(document.getElementById('m_jual3').value) || 0
        };
        dbBarang.push(item);
        db.ref('v26_barang').set(dbBarang).then(() => alert("Barang Tersimpan!"));
    }

    let keranjang = [];
    function handleKasirScan(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('scanKasir').value;
            // Cari di semua level barcode
            const b = dbBarang.find(x => x.bar1 === val || x.bar2 === val || x.bar3 === val || x.nama.toLowerCase().includes(val.toLowerCase()));
            
            if(b) {
                let sPilih = b.sat1, hPilih = b.jual1, kPilih = 1, mPilih = b.mod1;
                
                if(val === b.bar2) { sPilih = b.sat2; hPilih = b.jual2; kPilih = b.konv2; mPilih = b.mod1 * b.konv2; }
                else if(val === b.bar3) { sPilih = b.sat3; hPilih = b.jual3; kPilih = b.konv3; mPilih = b.mod1 * b.konv3; }

                keranjang.push({ ...b, displaySat: sPilih, harga: hPilih, konv: kPilih, modal: mPilih, qty: 1 });
                renderKeranjang();
            }
            document.getElementById('scanKasir').value = '';
        }
    }

    function renderKeranjang() {
        const b = document.getElementById('bodyKeranjang'); b.innerHTML = '';
        let total = 0;
        keranjang.forEach((k, i) => {
            let sub = k.qty * k.harga; total += sub;
            b.innerHTML += `<tr><td>${k.nama}</td><td>${k.displaySat}</td><td>${k.qty}</td><td>${sub.toLocaleString()}</td><td onclick="hapusItem(${i})">‚ùå</td></tr>`;
        });
        document.getElementById('totalBelanja').innerText = "Rp " + total.toLocaleString();
    }

    function prosesTransaksi() {
        if(keranjang.length === 0) return;
        let profit = 0, items = [];
        
        keranjang.forEach(item => {
            profit += (item.harga - item.modal) * item.qty;
            items.push(`${item.nama} ${item.qty}${item.displaySat}`);
            
            // Potong stok dasar (misal jual 1 DUS isi 120, stok berkurang 120)
            const idx = dbBarang.findIndex(x => x.nama === item.nama);
            if(idx !== -1) dbBarang[idx].stok -= (item.qty * item.konv);
        });

        const nota = {
            tgl: new Date().toISOString().split('T')[0],
            jam: new Date().toLocaleTimeString(),
            items: items.join(", "),
            total: keranjang.reduce((a,b) => a + (b.qty * b.harga), 0),
            profit: profit
        };

        dbRiwayat.unshift(nota);
        db.ref('v26_barang').set(dbBarang);
        db.ref('v26_riwayat').set(dbRiwayat).then(() => {
            alert("Transaksi Berhasil!");
            keranjang = []; renderKeranjang();
        });
    }

    function renderMaster() {
        const b = document.getElementById('bodyMaster'); b.innerHTML = '';
        dbBarang.forEach((x, i) => {
            b.innerHTML += `<tr>
                <td>${x.nama}</td>
                <td><b>${x.stok}</b> ${x.sat1}</td>
                <td>${x.jual1}/${x.jual2}/${x.jual3}</td>
                <td><button onclick="dbBarang[${i}].stok+=10; db.ref('v26_barang').set(dbBarang)">+10 Stok</button></td>
            </tr>`;
        });
    }

    function renderLaporan() {
        const tgl = document.getElementById('filterTgl').value;
        const b = document.getElementById('bodyLaporan'); b.innerHTML = '';
        dbRiwayat.filter(r => r.tgl === tgl).forEach(r => {
            b.innerHTML += `<tr><td>${r.jam}</td><td>${r.items}</td><td>${r.total}</td><td>${r.profit}</td></tr>`;
        });
    }
</script>
</body>
</html>
