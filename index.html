<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Final System v25.8</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --g: #6c757d; --bg: #f4f7f6; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); min-height: 100vh; color: #333; }
        
        .navbar { background: #fff; padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 10px 25px; display: flex; gap: 10px; overflow-x: auto; }
        .menu-item { color: #fff; cursor: pointer; padding: 10px 18px; border-radius: 5px; font-size: 13px; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover, .menu-item.active { background: var(--p); }

        .container { padding: 20px; max-width: 1300px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        input, button, select { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(90%); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 3% auto; padding: 25px; width: 90%; max-width: 480px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        .modal-footer { display: flex; gap: 12px; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px; }
        
        .hidden { display: none !important; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-g { background: var(--g); }
        .btn-edit { background: #ffc107; color: #000; padding: 6px 12px; border-radius: 6px; }
        .badge-stock { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="modalEdit" class="modal">
        <div class="modal-content">
            <h3 style="margin:0 0 15px 0; color:var(--dark)"><i class="fas fa-edit"></i> Edit Barang</h3>
            <input type="hidden" id="edit_index">
            <label style="font-size:12px; font-weight:bold">BARCODE</label>
            <input type="text" id="edit_kode">
            <label style="font-size:12px; font-weight:bold">NAMA BARANG</label>
            <input type="text" id="edit_nama">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label style="font-size:12px; font-weight:bold">MODAL (Rp)</label>
                    <input type="number" id="edit_modal">
                </div>
                <div style="flex:1">
                    <label style="font-size:12px; font-weight:bold">JUAL (Rp)</label>
                    <input type="number" id="edit_harga">
                </div>
            </div>
            <label style="font-size:12px; font-weight:bold">STOK</label>
            <input type="number" id="edit_stok">
            <div class="modal-footer">
                <button class="btn-s" onclick="simpanPerubahan()" style="flex: 2; padding: 15px;"><i class="fas fa-save"></i> SIMPAN</button>
                <button class="btn-g" onclick="closeModal()" style="flex: 1;">BATAL</button>
            </div>
        </div>
    </div>

    <div id="loginPage" style="max-width:400px; margin:100px auto; text-align: center;" class="card">
        <h1 style="color:var(--p); margin-bottom:5px">IKAMAPUSAT</h1>
        <p style="color:var(--g); margin-bottom:25px">Point of Sale & PPOB v25.8</p>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()" style="margin-top:10px">MASUK KE SISTEM</button>
    </div>

    <div id="appContainer" class="hidden">
        <div class="navbar">
            <h3 style="margin:0">IKAMA <span id="roleBadge" style="font-size:10px; background:#eee; padding:2px 6px;"></span></h3>
            <div id="displayUser" style="font-weight:bold"></div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showPage('kasir', this)"><i class="fas fa-shopping-cart"></i> Kasir</div>
            <div class="menu-item" onclick="showPage('ppob', this)"><i class="fas fa-mobile-alt"></i> PPOB</div>
            <div class="menu-item" onclick="showPage('laporan', this)"><i class="fas fa-file-invoice-dollar"></i> Laporan</div>
            <div class="menu-item adm-only" onclick="showPage('master', this)"><i class="fas fa-boxes"></i> Master Barang</div>
            <div class="menu-item adm-only" onclick="showPage('users', this)"><i class="fas fa-users-cog"></i> Kelola User</div>
            <div class="menu-item" onclick="location.reload()" style="background:var(--d)">Keluar</div>
        </div>

        <div class="container">
            <div id="page-kasir" class="section">
                <div class="grid" style="grid-template-columns: 1.5fr 1fr;">
                    <div class="card">
                        <h3>Penjualan Barang</h3>
                        <input type="text" id="scanKasir" placeholder="Scan Barcode / Ketik Nama..." onkeypress="handleKasirScan(event)" autofocus>
                        <table style="margin-top:20px">
                            <thead><tr><th>Item</th><th style="width:60px">Qty</th><th>Subtotal</th><th>#</th></tr></thead>
                            <tbody id="bodyKeranjang"></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h1 id="totalBelanja" style="text-align:right; font-size:45px; margin:0; color:var(--p)">Rp 0</h1>
                        <label>Diterima (Tunai):</label>
                        <input type="number" id="uangBayar" placeholder="Rp 0" oninput="hitungKembalian()" style="font-size:22px; font-weight:bold">
                        <h3 id="textKembalian" style="text-align:right; color:var(--d)">Kembali: Rp 0</h3>
                        <button class="btn-s" style="padding:20px; font-size:18px" onclick="prosesTransaksi()">SELESAI & SIMPAN</button>
                    </div>
                </div>
            </div>

            <div id="page-master" class="section hidden adm-only">
                <div class="grid">
                    <div class="card">
                        <h3><i class="fas fa-file-excel"></i> Import Excel</h3>
                        <div style="display:flex; gap:8px">
                            <input type="file" id="inputExcel" accept=".xlsx, .xls">
                            <button class="btn-s" onclick="importExcel()" style="width:120px">IMPORT</button>
                        </div>
                        <button class="btn-g" onclick="downloadTemplate()" style="margin-top:10px; width:100%"><i class="fas fa-download"></i> Download Template</button>
                    </div>
                    <div class="card">
                        <h3>Tambah Manual</h3>
                        <div class="grid" style="grid-template-columns: 1fr 1fr;">
                            <input type="text" id="m_kode" placeholder="Barcode">
                            <input type="text" id="m_nama" placeholder="Nama Barang">
                            <input type="number" id="m_modal" placeholder="Modal">
                            <input type="number" id="m_harga" placeholder="Jual">
                        </div>
                        <button class="btn-s" onclick="tambahBarang()" style="margin-top:10px">TAMBAH KE DATABASE</button>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                        <h3>Database Inventori</h3>
                        <input type="text" id="cariMaster" placeholder="Cari barcode/nama..." oninput="renderMaster()" style="width:250px">
                    </div>
                    <table>
                        <thead>
                            <tr><th>Barcode</th><th>Nama Barang</th><th>Harga Jual</th><th>Stok</th><th>Update Stok</th><th>Aksi</th></tr>
                        </thead>
                        <tbody id="bodyMaster"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-users" class="section hidden adm-only">
                <div class="grid">
                    <div class="card">
                        <h3>Tambah User (Kasir/Admin)</h3>
                        <input type="text" id="u_nama" placeholder="Nama Lengkap">
                        <input type="text" id="u_user" placeholder="Username untuk Login">
                        <input type="password" id="u_pass" placeholder="Password">
                        <select id="u_role">
                            <option value="kasir">KASIR / KARYAWAN</option>
                            <option value="admin">ADMINISTRATOR</option>
                        </select>
                        <button class="btn-s" onclick="tambahUser()" style="margin-top:10px"><i class="fas fa-user-plus"></i> SIMPAN USER</button>
                    </div>
                    <div class="card">
                        <h3>Daftar Pengguna</h3>
                        <table>
                            <thead>
                                <tr><th>Nama</th><th>Username</th><th>Role</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="bodyUsers"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-ppob" class="section hidden">
                <div class="card" style="max-width:600px; margin:auto">
                    <h3>Transaksi PPOB / Pulsa</h3>
                    <select id="p_layanan" onchange="updatePlaceholderPPOB()">
                        <option value="PULSA">PULSA / DATA</option>
                        <option value="TOKEN LISTRIK">TOKEN LISTRIK</option>
                        <option value="WIFI">VOUCHER WIFI</option>
                    </select>
                    <input type="text" id="p_tujuan" placeholder="Nomor HP">
                    <input type="text" id="p_nominal" placeholder="Nominal (Cth: 50.000)">
                    <div id="fieldToken" class="hidden"><input type="text" id="p_sn" placeholder="Masukkan 20 Digit Token"></div>
                    <div style="display:flex; gap:10px">
                        <input type="number" id="p_harga" placeholder="Harga Jual">
                        <input type="number" id="p_modal" placeholder="Modal">
                    </div>
                    <button class="btn-s" onclick="prosesPPOB()" style="margin-top:10px"><i class="fas fa-print"></i> PROSES & CETAK</button>
                </div>
            </div>

            <div id="page-laporan" class="section hidden">
                <div class="card">
                    <h3>Laporan Penjualan</h3>
                    <input type="date" id="filterTgl" onchange="renderLaporan()" style="width:200px">
                    <table style="margin-top:20px">
                        <thead>
                            <tr><th>Jam</th><th>Kasir</th><th>Items</th><th>Total</th><th class="adm-only">Profit</th></tr>
                        </thead>
                        <tbody id="bodyLaporan"></tbody>
                        <tfoot id="footLaporan"></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        authDomain: "kasir-ikamapusat.firebaseapp.com",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasir-ikamapusat",
        storageBucket: "kasir-ikamapusat.firebasestorage.app",
        messagingSenderId: "375649394523",
        appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
    };
    firebase.initializeApp(firebaseConfig);
    const dbCloud = firebase.database();
    
    let dbBarang = [], dbRiwayat = [], dbUsers = [], keranjang = [], userLogin = null;

    // Sinkronisasi Data
    dbCloud.ref('v25_barang').on('value', snap => { dbBarang = snap.val() || []; renderMaster(); });
    dbCloud.ref('v25_riwayat').on('value', snap => { dbRiwayat = snap.val() || []; renderLaporan(); });
    dbCloud.ref('v25_users').on('value', snap => { 
        dbUsers = snap.val() || [{nama:'Admin', user:'admin', pass:'123', role:'admin'}];
        renderUsers();
    });

    // --- MANAJEMEN USER ---
    function renderUsers() {
        const b = document.getElementById('bodyUsers'); if(!b) return;
        b.innerHTML = '';
        dbUsers.forEach((u, i) => {
            b.innerHTML += `<tr>
                <td>${u.nama}</td>
                <td>${u.user}</td>
                <td><span class="badge-stock" style="background:#eee">${u.role.toUpperCase()}</span></td>
                <td>
                    ${u.user === 'admin' ? '-' : `<button class="btn-d" onclick="hapusUser(${i})" style="padding:5px 10px"><i class="fas fa-trash"></i></button>`}
                </td>
            </tr>`;
        });
    }

    function tambahUser() {
        const n = document.getElementById('u_nama'), u = document.getElementById('u_user'), p = document.getElementById('u_pass'), r = document.getElementById('u_role');
        if(!n.value || !u.value || !p.value) return alert("Lengkapi data user!");
        
        dbUsers.push({nama: n.value, user: u.value, pass: p.value, role: r.value});
        dbCloud.ref('v25_users').set(dbUsers).then(() => {
            alert("User berhasil ditambahkan!");
            n.value = ''; u.value = ''; p.value = '';
        });
    }

    function hapusUser(i) {
        if(confirm("Hapus user ini?")) {
            dbUsers.splice(i, 1);
            dbCloud.ref('v25_users').set(dbUsers);
        }
    }

    // --- AUTH ---
    function doLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const found = dbUsers.find(x => x.user === u && x.pass === p);
        if(found) {
            userLogin = found;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('displayUser').innerText = userLogin.nama;
            document.getElementById('roleBadge').innerText = userLogin.role.toUpperCase();
            if(userLogin.role !== 'admin') {
                document.querySelectorAll('.adm-only').forEach(e => e.classList.add('hidden'));
            }
            document.getElementById('filterTgl').valueAsDate = new Date();
        } else alert("Akses Ditolak! Periksa kembali Username & Password.");
    }

    function showPage(p, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('page-'+p).classList.remove('hidden');
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        el.classList.add('active');
    }

    // --- MASTER & IMPORT ---
    function renderMaster() {
        const b = document.getElementById('bodyMaster'); if(!b) return;
        const cari = document.getElementById('cariMaster').value.toLowerCase();
        b.innerHTML = '';
        dbBarang.forEach((brg, i) => {
            if(brg.nama.toLowerCase().includes(cari) || brg.kode.toLowerCase().includes(cari)) {
                const sColor = brg.stok < 5 ? 'background:#ffcccc; color:red' : 'background:#ccffcc; color:green';
                b.innerHTML += `<tr>
                    <td>${brg.kode}</td>
                    <td><b>${brg.nama}</b></td>
                    <td>Rp ${brg.harga.toLocaleString()}</td>
                    <td><span class="badge-stock" style="${sColor}">${brg.stok}</span></td>
                    <td><input type="number" placeholder="Stok Baru" style="width:100px; padding:5px" onkeypress="if(event.key==='Enter') quickStock(${i}, this.value)"></td>
                    <td>
                        <button class="btn-edit" onclick="openEdit(${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-d" onclick="hapusBarang(${i})" style="padding:6px 12px"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }
        });
    }

    function quickStock(i, v) {
        if(v==="" || v < 0) return;
        dbBarang[i].stok = parseInt(v);
        dbCloud.ref('v25_barang').set(dbBarang).then(() => alert("Stok Diperbarui!"));
    }

    function importExcel() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return alert("Pilih file excel!");
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            if(confirm(`Impor ${json.length} item?`)) {
                json.forEach(x => {
                    dbBarang.push({
                        kode: x.Barcode.toString(), nama: x.Nama, 
                        modal: parseInt(x.Modal)||0, harga: parseInt(x.Jual)||0, stok: parseInt(x.Stok)||0
                    });
                });
                dbCloud.ref('v25_barang').set(dbBarang).then(() => alert("Sukses Impor!"));
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function downloadTemplate() {
        const data = [["Barcode", "Nama", "Modal", "Jual", "Stok"], ["8999", "Contoh Item", 5000, 7000, 10]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Barang");
        XLSX.writeFile(wb, "Template_IKAMA.xlsx");
    }

    function openEdit(i) {
        const b = dbBarang[i];
        document.getElementById('edit_index').value = i;
        document.getElementById('edit_kode').value = b.kode;
        document.getElementById('edit_nama').value = b.nama;
        document.getElementById('edit_modal').value = b.modal;
        document.getElementById('edit_harga').value = b.harga;
        document.getElementById('edit_stok').value = b.stok;
        document.getElementById('modalEdit').style.display = 'block';
    }

    function closeModal() { document.getElementById('modalEdit').style.display = 'none'; }

    function simpanPerubahan() {
        const i = document.getElementById('edit_index').value;
        dbBarang[i] = {
            kode: document.getElementById('edit_kode').value,
            nama: document.getElementById('edit_nama').value,
            modal: parseInt(document.getElementById('edit_modal').value) || 0,
            harga: parseInt(document.getElementById('edit_harga').value) || 0,
            stok: parseInt(document.getElementById('edit_stok').value) || 0
        };
        dbCloud.ref('v25_barang').set(dbBarang).then(() => { closeModal(); alert("Berhasil Diupdate!"); });
    }

    function tambahBarang() {
        const k=document.getElementById('m_kode'), n=document.getElementById('m_nama'), mod=document.getElementById('m_modal'), h=document.getElementById('m_harga');
        if(!k.value || !n.value) return alert("Isi Kode & Nama!");
        dbBarang.push({kode:k.value, nama:n.value, modal:parseInt(mod.value)||0, harga:parseInt(h.value)||0, stok:0});
        dbCloud.ref('v25_barang').set(dbBarang).then(() => { k.value=''; n.value=''; mod.value=''; h.value=''; k.focus(); });
    }

    function hapusBarang(i) { if(confirm("Hapus barang?")) { dbBarang.splice(i,1); dbCloud.ref('v25_barang').set(dbBarang); } }

    // --- KASIR LOGIC ---
    function handleKasirScan(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('scanKasir').value;
            const b = dbBarang.find(x => x.kode === val || x.nama.toLowerCase().includes(val.toLowerCase()));
            if(b) {
                const ada = keranjang.find(k => k.kode === b.kode);
                if(ada) ada.qty++; else keranjang.push({...b, qty:1});
                renderKeranjang();
            }
            document.getElementById('scanKasir').value = '';
        }
    }

    function renderKeranjang() {
        const b = document.getElementById('bodyKeranjang'); b.innerHTML = '';
        let total = 0;
        keranjang.forEach((k, i) => {
            let sub = k.qty * k.harga; total += sub;
            b.innerHTML += `<tr><td>${k.nama}</td><td><input type="number" style="width:50px" value="${k.qty}" onchange="updateQty(${i}, this.value)"></td><td>${sub.toLocaleString()}</td><td><button onclick="updateQty(${i},0)" style="background:none; color:red">X</button></td></tr>`;
        });
        document.getElementById('totalBelanja').innerText = "Rp " + total.toLocaleString();
        hitungKembalian();
    }

    function updateQty(i, v) { if(v<=0) keranjang.splice(i,1); else keranjang[i].qty=parseInt(v); renderKeranjang(); }

    function hitungKembalian() {
        const t = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,'')) || 0;
        const b = parseInt(document.getElementById('uangBayar').value) || 0;
        document.getElementById('textKembalian').innerText = "Kembali: Rp " + (b-t < 0 ? 0 : b-t).toLocaleString();
    }

    function prosesTransaksi() {
        const total = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,''));
        if(total === 0) return;
        let profit = 0, items = [];
        keranjang.forEach(item => {
            profit += (item.qty * (item.harga - item.modal));
            items.push(`${item.nama}(${item.qty})`);
            const idx = dbBarang.findIndex(b => b.kode === item.kode);
            if(idx !== -1) dbBarang[idx].stok -= item.qty;
        });
        const skrg = new Date();
        dbRiwayat.unshift({
            tgl: skrg.toISOString().split('T')[0], jam: skrg.getHours().toString().padStart(2,'0')+":"+skrg.getMinutes().toString().padStart(2,'0'),
            kasir: userLogin.nama, items: items.join(", "), total: total, profit: profit
        });
        dbCloud.ref('v25_barang').set(dbBarang);
        dbCloud.ref('v25_riwayat').set(dbRiwayat).then(() => { alert("Transaksi Berhasil!"); keranjang = []; renderKeranjang(); document.getElementById('uangBayar').value = ''; });
    }

    // --- PPOB & LAPORAN ---
    function updatePlaceholderPPOB() {
        const lay = document.getElementById('p_layanan').value;
        document.getElementById('fieldToken').className = (lay === 'TOKEN LISTRIK' ? '' : 'hidden');
    }

    function prosesPPOB() {
        const hrg = parseInt(document.getElementById('p_harga').value) || 0, mod = parseInt(document.getElementById('p_modal').value) || 0;
        if(hrg <= 0) return;
        const skrg = new Date();
        dbRiwayat.unshift({
            tgl: skrg.toISOString().split('T')[0], jam: skrg.getHours().toString().padStart(2,'0')+":"+skrg.getMinutes().toString().padStart(2,'0'),
            kasir: userLogin.nama, items: `[PPOB] ${document.getElementById('p_layanan').value} ${document.getElementById('p_nominal').value}`, 
            total: hrg, profit: hrg - mod
        });
        dbCloud.ref('v25_riwayat').set(dbRiwayat).then(() => alert("PPOB Berhasil!"));
    }

    function renderLaporan() {
        const tgl = document.getElementById('filterTgl').value;
        const b = document.getElementById('bodyLaporan'), f = document.getElementById('footLaporan');
        if(!b) return;
        b.innerHTML = ''; let tUang = 0, tProfit = 0;
        dbRiwayat.filter(r => r.tgl === tgl).forEach(r => {
            tUang += r.total; tProfit += r.profit;
            b.innerHTML += `<tr><td>${r.jam}</td><td>${r.kasir}</td><td><small>${r.items}</small></td><td>${r.total.toLocaleString()}</td><td class="${userLogin.role !== 'admin' ? 'hidden' : ''}">${r.profit.toLocaleString()}</td></tr>`;
        });
        f.innerHTML = `<tr style="font-weight:bold; background:#eee"><td colspan="3" align="right">TOTAL:</td><td>Rp ${tUang.toLocaleString()}</td><td class="${userLogin.role !== 'admin' ? 'hidden' : ''}">Rp ${tProfit.toLocaleString()}</td></tr>`;
    }
</script>
</body>
</html>
