<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="UTF-8">
<title>IKAMAPUSAT v25 FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
.hidden{display:none}
.card{background:#fff;padding:20px;border-radius:10px;margin-bottom:15px}
.btn-d{background:#dc3545;color:#fff;padding:8px;border:none;border-radius:6px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #eee;padding:8px}
th{background:#f5f5f5}
</style>

</head>
<body>

<!-- ================= POPUP DETAIL ================= -->

<div id="popupDetail" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999">
  <div class="card" style="max-width:700px;width:95%">
    <h3>Detail Transaksi</h3>
    <div id="popupIsi"></div>
    <button class="btn-d" onclick="tutupPopup()">Tutup</button>
  </div>
</div>

<!-- ================= LAPORAN ================= -->

<div class="card">
  <h3>Laporan Transaksi</h3>
  <table>
    <thead>
      <tr>
        <th>Waktu</th>
        <th>Kasir</th>
        <th>Item</th>
        <th>Total</th>
        <th>Profit</th>
      </tr>
    </thead>
    <tbody id="bodyLaporan"></tbody>
  </table>
</div>

<div class="card">
  <h3>Laporan Per Kasir</h3>
  <table>
    <thead>
      <tr>
        <th>Kasir</th>
        <th>Transaksi</th>
        <th>Item</th>
        <th>Omzet</th>
        <th>Profit</th>
      </tr>
    </thead>
    <tbody id="bodyPerKasir"></tbody>
  </table>
</div>

<div class="card">
  <h3>Barang Terlaris</h3>
  <table>
    <thead>
      <tr>
        <th>Barang</th>
        <th>Qty</th>
        <th>Omzet</th>
      </tr>
    </thead>
    <tbody id="bodyTerlaris"></tbody>
  </table>
</div>

<script>
// ====== SIMULASI DATA ======
let dbRiwayat = [];
let userLogin = {nama:'Admin'};

// ====== SIMPAN TRANSAKSI ======
function prosesTransaksi(keranjang){
  let total=0, profit=0;
  keranjang.forEach(i=>{
    total+=i.qty*i.harga;
    profit+=i.qty*(i.harga-i.modal);
  });
  const now=new Date();
  dbRiwayat.unshift({
    waktu:now.toLocaleString('id-ID'),
    kasir:userLogin.nama,
    total,profit,
    items:keranjang.map(i=>({
      nama:i.nama,qty:i.qty,harga:i.harga,subtotal:i.qty*i.harga
    }))
  });
  renderLaporan();
}

// ====== LAPORAN ======
function renderLaporan(){
  const b=document.getElementById('bodyLaporan');
  b.innerHTML='';
  dbRiwayat.forEach(r=>{
    b.innerHTML+=`<tr onclick='bukaDetail(${JSON.stringify(r)})' style="cursor:pointer">
      <td>${r.waktu}</td>
      <td>${r.kasir}</td>
      <td>${r.items.map(i=>i.nama+'('+i.qty+')').join('<br>')}</td>
      <td>${r.total.toLocaleString()}</td>
      <td>${r.profit.toLocaleString()}</td>
    </tr>`;
  });
  renderPerKasir(dbRiwayat);
  renderBarangTerlaris(dbRiwayat);
}

// ====== POPUP ======
function bukaDetail(r){
  let h=`<table><tr><th>Barang</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr>`;
  r.items.forEach(i=>h+=`<tr><td>${i.nama}</td><td>${i.qty}</td><td>${i.harga}</td><td>${i.subtotal}</td></tr>`);
  h+=`</table><h3>Total: Rp ${r.total.toLocaleString()}</h3>`;
  document.getElementById('popupIsi').innerHTML=h;
  document.getElementById('popupDetail').classList.remove('hidden');
}
function tutupPopup(){document.getElementById('popupDetail').classList.add('hidden');}

// ====== PER KASIR ======
function renderPerKasir(data){
  const map={};
  data.forEach(r=>{
    if(!map[r.kasir])map[r.kasir]={trx:0,item:0,omzet:0,profit:0};
    map[r.kasir].trx++;
    map[r.kasir].omzet+=r.total;
    map[r.kasir].profit+=r.profit;
    r.items.forEach(i=>map[r.kasir].item+=i.qty);
  });
  const b=document.getElementById('bodyPerKasir');
  b.innerHTML='';
  Object.entries(map).forEach(([k,v])=>{
    b.innerHTML+=`<tr><td>${k}</td><td>${v.trx}</td><td>${v.item}</td><td>${v.omzet.toLocaleString()}</td><td>${v.profit.toLocaleString()}</td></tr>`;
  });
}

// ====== BARANG TERLARIS ======
function renderBarangTerlaris(data){
  const map={};
  data.forEach(r=>r.items.forEach(i=>{
    if(!map[i.nama])map[i.nama]={qty:0,omzet:0};
    map[i.nama].qty+=i.qty;
    map[i.nama].omzet+=i.subtotal;
  }));
  const b=document.getElementById('bodyTerlaris');
  b.innerHTML='';
  Object.entries(map).sort((a,b)=>b[1].qty-a[1].qty)
    .forEach(([n,v])=>b.innerHTML+=`<tr><td>${n}</td><td>${v.qty}</td><td>${v.omzet.toLocaleString()}</td></tr>`);
}

// ====== CONTOH EKSEKUSI ======
prosesTransaksi([
  {nama:'Beras',qty:2,harga:12000,modal:10000},
  {nama:'Gula',qty:1,harga:15000,modal:12000}
]);
</script>

</body>
</html>
