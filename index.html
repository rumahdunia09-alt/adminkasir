<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Kasir Pro v11 (Bulk Import)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --g: #6c757d; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; color: #333; min-height: 100vh; display: flex; flex-direction: column; }
        .navbar { background: #fff; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-brand { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 40px; width: auto; }
        .container { padding: 20px; max-width: 1200px; margin: auto; flex: 1; width: 100%; box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stat-box { padding: 20px; border-radius: 10px; color: white; text-align: center; }
        input, button, select { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: var(--p); color: white; border: none; font-weight: bold; }
        .btn-s { background: var(--s); } .btn-d { background: var(--d); } .btn-g { background: var(--g); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #fafafa; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; background: #eee; color: #666; }
        .import-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px dashed #ccc; }
    </style>
</head>
<body>

    <div id="loginPage" style="max-width: 400px; margin: 80px auto;" class="card">
        <img src="logo.png" style="display:block; margin:0 auto 15px; height:80px;" onerror="this.style.display='none'">
        <h2 style="text-align:center; margin-top:0">IKAMAPUSAT LOGIN</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()">MASUK</button>
    </div>

    <div id="appContainer" style="display:none;">
        <div class="navbar">
            <div class="nav-brand"><img src="logo.png" class="logo-img" onerror="this.style.display='none'"><h3>IKAMAPUSAT CLOUD</h3></div>
            <div><span id="displayUser" style="margin-right:15px; font-weight:bold"></span><button class="btn-d" style="width:auto; padding:8px 15px" onclick="location.reload()">Keluar</button></div>
        </div>

        <div class="container">
            <div id="dashboardSection" class="grid" style="display:none">
                <div class="stat-box" style="background: var(--p);"><small>Omzet Hari Ini</small><h2 id="omzetHariIni">Rp 0</h2></div>
                <div class="stat-box" style="background: var(--s);"><small>Profit Hari Ini</small><h2 id="profitHariIni">Rp 0</h2></div>
                <div class="stat-box" style="background: var(--g);"><small>Total Transaksi</small><h2 id="trxHariIni">0</h2></div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Kasir</h3>
                    <input type="text" id="scanKasir" placeholder="Cari Nama / Scan Barcode..." onkeypress="handleKasirScan(event)">
                    <table>
                        <thead><tr><th>Produk</th><th style="width:80px">Qty</th><th>Subtotal</th></tr></thead>
                        <tbody id="bodyKeranjang"></tbody>
                    </table>
                    <h2 id="totalBelanja" style="text-align:right; color:var(--s); margin:10px 0;">Total: Rp 0</h2>
                    <select id="metodeBayar"><option value="Tunai">Tunai</option><option value="QRIS / DANA">QRIS / DANA</option></select>
                    <input type="number" id="bayar" placeholder="Jumlah Bayar (Rp)" oninput="hitungKembalian()">
                    <h3 id="kembalian" style="text-align:right; color:var(--d);">Kembali: Rp 0</h3>
                    <button class="btn-s" onclick="prosesTransaksi()">KONFIRMASI LUNAS</button>
                </div>

                <div class="card">
                    <h3>Laporan Penjualan</h3>
                    <div style="display:flex; gap:5px;"><input type="date" id="filterTanggal"><button class="btn-g" style="width:auto" onclick="renderRiwayat()">Cari</button></div>
                    <div style="max-height: 400px; overflow-y: auto;"><table><thead><tr><th>Waktu</th><th>Total</th><th>Aksi</th></tr></thead><tbody id="bodyRiwayat"></tbody></table></div>
                </div>
            </div>

            <div id="adminPanel" class="card" style="display:none">
                <h3>Master Barang & Import Massal</h3>
                <div class="import-box">
                    <small><strong>Import dari Excel (CSV):</strong> Format kolom: Kode, Nama, Kategori, Satuan, Modal, Harga, Stok</small>
                    <input type="file" id="csvFile" accept=".csv">
                    <button class="btn-g" onclick="importCSV()">IMPORT DATA MASSAL</button>
                </div>
                <div class="grid">
                    <div>
                        <input type="text" id="m_kode" placeholder="Barcode">
                        <input type="text" id="m_nama" placeholder="Nama Barang">
                        <select id="m_kat"><option value="Umum">Pilih Kategori</option><option value="Makanan">Makanan</option><option value="Minuman">Minuman</option><option value="Sembako">Sembako</option></select>
                        <select id="m_satuan"><option value="pcs">Pcs</option><option value="kg">Kg</option><option value="ltr">Ltr</option><option value="dus">Dus</option></select>
                        <input type="number" id="m_modal" placeholder="Harga Modal">
                        <input type="number" id="m_harga" placeholder="Harga Jual">
                        <input type="number" id="m_stok" placeholder="Stok">
                        <button class="btn-s" onclick="tambahBarang()">SIMPAN MANUAL</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table><thead><tr><th>Nama/Kategori</th><th>Satuan</th><th>Harga</th><th>Stok</th><th>X</th></tr></thead><tbody id="bodyMaster"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align:center; padding:20px; font-size:12px; color:#999;">By: Duniatanpaspasi-2026 | IKAMAPUSAT CLOUD</div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        authDomain: "kasir-ikamapusat.firebaseapp.com",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasir-ikamapusat",
        storageBucket: "kasir-ikamapusat.firebasestorage.app",
        messagingSenderId: "375649394523",
        appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
    };

    firebase.initializeApp(firebaseConfig);
    const dbCloud = firebase.database();
    let dbBarang = [], dbRiwayat = [], keranjang = [], currentUser = null;

    document.getElementById('filterTanggal').valueAsDate = new Date();
    dbCloud.ref('v11_barang').on('value', snap => { dbBarang = snap.val() || []; renderMaster(); updateDashboard(); });
    dbCloud.ref('v11_riwayat').on('value', snap => { dbRiwayat = snap.val() || []; renderRiwayat(); updateDashboard(); });

    function doLogin() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        if(u === 'admin' && p === '123') {
            currentUser = {nama: 'Owner Admin', role: 'admin'};
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('displayUser').innerText = currentUser.nama;
            document.getElementById('adminPanel').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'grid';
        } else { alert("Gagal!"); }
    }

    // --- FITUR IMPORT CSV ---
    function importCSV() {
        const fileInput = document.getElementById('csvFile');
        if (!fileInput.files[0]) return alert("Pilih file CSV dulu!");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split("\n");
            rows.forEach((row, index) => {
                if (index === 0 || row.trim() === "") return; // Skip header/empty
                const cols = row.split(",");
                if (cols.length >= 7) {
                    dbBarang.push({
                        kode: cols[0].trim(),
                        nama: cols[1].trim(),
                        kategori: cols[2].trim(),
                        satuan: cols[3].trim(),
                        modal: parseInt(cols[4]),
                        harga: parseInt(cols[5]),
                        stok: parseInt(cols[6])
                    });
                }
            });
            dbCloud.ref('v11_barang').set(dbBarang);
            alert("Berhasil mengimport data!");
        };
        reader.readAsText(fileInput.files[0]);
    }

    function handleKasirScan(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('scanKasir').value;
            const b = dbBarang.find(x => x.kode === val || x.nama.toLowerCase().includes(val.toLowerCase()));
            if(b && b.stok > 0) {
                const ada = keranjang.find(k => k.kode === b.kode);
                if(ada) { if(ada.qty < b.stok) ada.qty++; }
                else { keranjang.push({...b, qty: 1}); }
                renderKeranjang();
            }
            document.getElementById('scanKasir').value = '';
        }
    }

    function renderKeranjang() {
        const b = document.getElementById('bodyKeranjang'); b.innerHTML = '';
        let t = 0;
        keranjang.forEach((k, i) => {
            let sub = k.qty * k.harga; t += sub;
            b.innerHTML += `<tr><td>${k.nama}<br><small>${k.satuan}</small></td><td><input type="number" class="qty-input" value="${k.qty}" onchange="changeQty(${i}, this.value)"></td><td>Rp ${sub.toLocaleString()}</td></tr>`;
        });
        document.getElementById('totalBelanja').innerText = "Total: Rp " + t.toLocaleString();
    }

    function changeQty(i, q) {
        const n = parseInt(q); const item = keranjang[i];
        const ori = dbBarang.find(b => b.kode === item.kode);
        if(n > ori.stok) { alert("Stok kurang!"); item.qty = ori.stok; }
        else if(n <= 0) { keranjang.splice(i, 1); }
        else { item.qty = n; }
        renderKeranjang();
    }

    function hitungKembalian() {
        const t = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,'')) || 0;
        const b = parseInt(document.getElementById('bayar').value) || 0;
        const k = b - t;
        document.getElementById('kembalian').innerText = "Kembali: Rp " + (k < 0 ? 0 : k).toLocaleString();
    }

    function prosesTransaksi() {
        if(keranjang.length === 0) return;
        const b = parseInt(document.getElementById('bayar').value) || 0;
        const t = parseInt(document.getElementById('totalBelanja').innerText.replace(/\D/g,''));
        if(b < t) return alert("Uang kurang!");

        let prof = 0;
        keranjang.forEach(it => {
            prof += (it.qty * (it.harga - it.modal));
            const idx = dbBarang.findIndex(db => db.kode === it.kode);
            if(idx !== -1) dbBarang[idx].stok -= it.qty;
        });

        const trx = {
            id: Date.now(),
            waktu: new Date().toLocaleString('id-ID'),
            tanggal: new Date().toISOString().split('T')[0],
            total: t, profit: prof,
            metode: document.getElementById('metodeBayar').value,
            items: [...keranjang]
        };

        dbRiwayat.unshift(trx);
        dbCloud.ref('v11_barang').set(dbBarang);
        dbCloud.ref('v11_riwayat').set(dbRiwayat);
        alert("LUNAS!"); keranjang = []; renderKeranjang();
    }

    function renderRiwayat() {
        const f = document.getElementById('filterTanggal').value;
        const b = document.getElementById('bodyRiwayat'); b.innerHTML = '';
        dbRiwayat.filter(r => r.tanggal === f).forEach(r => {
            b.innerHTML += `<tr><td>${r.waktu.split(' ')[1]}</td><td>Rp ${r.total.toLocaleString()}</td><td><button class="btn-g" onclick="cetakManual(${r.id})">Cetak</button></td></tr>`;
        });
    }

    function cetakManual(id) {
        const r = dbRiwayat.find(x => x.id === id);
        let s = `<style>body{font-family:monospace;width:200px;font-size:12px}.c{text-align:center}</style>
                 <div class="c"><strong>IKAMAPUSAT</strong><br>${r.waktu}<br>---</div>`;
        r.items.forEach(it => { s += `<div>${it.nama} x${it.qty} ${it.satuan}<br>Rp ${(it.qty*it.harga).toLocaleString()}</div>`; });
        s += `<br><strong>TOTAL: Rp ${r.total.toLocaleString()}</strong><br>Bayar: ${r.metode}<br><div class="c">*** LUNAS ***</div><br><div class="c"><img src="qris.png" width="120" onerror="this.style.display='none'"></div>`;
        const w = window.open('', '_blank', 'width=300,height=400'); w.document.write(s); w.print(); w.close();
    }

    function tambahBarang() {
        const k = document.getElementById('m_kode').value, n = document.getElementById('m_nama').value;
        const kat = document.getElementById('m_kat').value, sat = document.getElementById('m_satuan').value;
        const m = parseInt(document.getElementById('m_modal').value), h = parseInt(document.getElementById('m_harga').value), s = parseInt(document.getElementById('m_stok').value);
        if(!k || !n) return;
        dbBarang.push({kode:k, nama:n, kategori:kat, satuan:sat, modal:m, harga:h, stok:s});
        dbCloud.ref('v11_barang').set(dbBarang);
        alert("Tersimpan!");
    }

    function renderMaster() {
        const b = document.getElementById('bodyMaster'); b.innerHTML = '';
        dbBarang.forEach((br, i) => {
            b.innerHTML += `<tr><td>${br.nama}<br><span class="badge">${br.kategori}</span></td><td>${br.satuan}</td><td>${br.harga.toLocaleString()}</td><td style="${br.stok<=5?'color:red;font-weight:bold':''}">${br.stok}</td><td><button class="btn-d" style="width:auto;padding:2px 5px" onclick="hapusBarang(${i})">X</button></td></tr>`;
        });
    }

    function updateDashboard() {
        const tgl = new Date().toLocaleDateString('id-ID');
        let o = 0, p = 0, c = 0;
        dbRiwayat.forEach(r => { if(r.waktu.includes(tgl)) { o += r.total; p += (r.profit || 0); c++; }});
        document.getElementById('omzetHariIni').innerText = "Rp " + o.toLocaleString();
        document.getElementById('profitHariIni').innerText = "Rp " + p.toLocaleString();
        document.getElementById('trxHariIni').innerText = c;
    }
    function hapusBarang(i) { if(confirm("Hapus?")) { dbBarang.splice(i,1); dbCloud.ref('v11_barang').set(dbBarang); }}
</script>
</body>
</html>
