<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT v26.0 - Database Synced</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --p: #007bff; --s: #28a745; --d: #dc3545; --dark: #2c3e50; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); }
        .navbar { background: #fff; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .menu-bar { background: var(--dark); padding: 5px 20px; display: flex; gap: 5px; }
        .menu-item { color: #fff; cursor: pointer; padding: 12px 20px; border-radius: 5px; font-size: 14px; }
        .menu-item.active { background: var(--p); }
        .container { padding: 20px; max-width: 1500px; margin: auto; }
        .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f1f3f5; color: #495057; font-weight: 600; }
        input, button { padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .btn-del { background: var(--d); color: white; border: none; cursor: pointer; padding: 5px 10px; border-radius: 4px; }
        .stok-low { color: var(--d); font-weight: bold; }
    </style>
</head>
<body>

    <div id="app">
        <div class="navbar">
            <h2 style="margin:0; color:var(--p)">IKAMA <small style="color:#666">v26.0</small></h2>
            <div id="userStat">Administrator</div>
        </div>

        <div class="menu-bar">
            <div class="menu-item active" onclick="showP('kasir')">Kasir</div>
            <div class="menu-item" onclick="showP('master')">Master & Import</div>
        </div>

        <div class="container">
            <div id="p-master" class="section hidden">
                <div class="card" style="border-top: 4px solid var(--s)">
                    <h3><i class="fas fa-file-excel"></i> Import Database Excel</h3>
                    <p style="font-size:12px; color:#666">Sistem akan membaca mulai baris ke-2 (Baris Header Biru).</p>
                    <input type="file" id="xlInput" accept=".xlsx, .xls">
                    <button onclick="importData()" style="background:var(--s); color:white; font-weight:bold">PROSES IMPORT</button>
                    <button onclick="clearData()" style="background:var(--d); color:white; margin-left:10px">HAPUS SEMUA DATA</button>
                </div>

                <div class="card">
                    <h3>Daftar Inventori</h3>
                    <table id="invTable">
                        <thead>
                            <tr>
                                <th>KODE</th><th>NAMA ITEM</th><th>STOK</th><th>L1 (Ecer)</th><th>L2</th><th>L3</th><th>L4</th><th>HPP</th><th>AKSI</th>
                            </tr>
                        </thead>
                        <tbody id="invBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="p-kasir" class="section">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
                    <div class="card">
                        <input type="text" id="scan" placeholder="Scan Barcode Satuan 1, 2, 3, atau 4..." style="width:100%; font-size:18px" onkeypress="handleScan(event)">
                        <table style="margin-top:20px">
                            <thead><tr><th>Produk</th><th>Satuan</th><th>Harga</th><th>Qty</th><th>Subtotal</th></tr></thead>
                            <tbody id="cartBody"></tbody>
                        </table>
                    </div>
                    <div class="card" style="text-align:right">
                        <p>Total Tagihan:</p>
                        <h1 id="total" style="font-size:45px; margin:0; color:var(--p)">Rp 0</h1>
                        <button onclick="checkOut()" style="width:100%; padding:15px; background:var(--s); color:white; font-size:18px; margin-top:20px">BAYAR</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let masterBrg = [], cart = [];

    // Sync Data
    db.ref('v26_master').on('value', s => { masterBrg = s.val() || []; renderMaster(); });

    function showP(p) {
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById('p-'+p).classList.remove('hidden');
    }

    // LOGIK IMPORT SESUAI TABEL DATABASE ANDA
    function importData() {
        const file = document.getElementById('xlInput').files[0];
        if(!file) return alert("Pilih file!");
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            // Range 1 = Mulai baca dari baris ke-2 (A2, B2, dst)
            const data = XLSX.utils.sheet_to_json(sheet, { range: 1 });
            
            let updated = [];
            data.forEach(r => {
                if(r["NAMA ITEM"]) { // Validasi: Hanya masukkan jika ada nama
                    updated.push({
                        kode: r["KODE ITEM"] || r["BARCODE SATUAN 1"],
                        nama: r["NAMA ITEM"],
                        stok: parseInt(r["STOK AWAL SATUAN DASAR"]) || 0,
                        hpp: parseInt(r["HARGA POKOK SATUAN 1"]) || 0,
                        u1: { name: r["SATUAN 1"], bar: String(r["BARCODE SATUAN 1"]||""), jual: parseInt(r["HARGA JUAL SATUAN 1"])||0, konv: 1 },
                        u2: { name: r["SATUAN 2"], bar: String(r["BARCODE SATUAN 2"]||""), jual: parseInt(r["HARGA JUAL SATUAN 2"])||0, konv: parseInt(r["KONVERSI SATUAN 2"])||0 },
                        u3: { name: r["SATUAN 3"], bar: String(r["BARCODE SATUAN 3"]||""), jual: parseInt(r["HARGA JUAL SATUAN 3"])||0, konv: parseInt(r["KONVERSI I SATUAN 3"])||0 },
                        u4: { name: r["SATUAN 4"], bar: String(r["BARCODE SATUAN 4"]||""), jual: parseInt(r["HARGA JUAL SATUAN 4"])||0, konv: parseInt(r["KONVERSI SATUAN 4"])||0 }
                    });
                }
            });
            db.ref('v26_master').set(updated).then(() => alert("Sinkronisasi Berhasil!"));
        };
        reader.readAsArrayBuffer(file);
    }

    function renderMaster() {
        const b = document.getElementById('invBody'); b.innerHTML = '';
        masterBrg.forEach((x, i) => {
            b.innerHTML += `<tr>
                <td>${x.kode}</td>
                <td><b>${x.nama}</b></td>
                <td class="${x.stok < 5 ? 'stok-low' : ''}">${x.stok}</td>
                <td>${x.u1.jual.toLocaleString()} (${x.u1.name})</td>
                <td>${x.u2.jual.toLocaleString()} (${x.u2.name || '-'})</td>
                <td>${x.u3.jual.toLocaleString()} (${x.u3.name || '-'})</td>
                <td>${x.u4.jual.toLocaleString()} (${x.u4.name || '-'})</td>
                <td>${x.hpp.toLocaleString()}</td>
                <td><button class="btn-del" onclick="delItem(${i})"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
    }

    function handleScan(e) {
        if(e.key === 'Enter') {
            const v = e.target.value;
            let item = null, level = 1;
            
            masterBrg.forEach(b => {
                if(b.u1.bar === v) { item = b; level = 1; }
                else if(b.u2.bar === v) { item = b; level = 2; }
                else if(b.u3.bar === v) { item = b; level = 3; }
                else if(b.u4.bar === v) { item = b; level = 4; }
            });

            if(item) {
                const u = item['u'+level];
                cart.push({ nama: item.nama, unit: u.name, harga: u.jual, qty: 1, konv: u.konv, id: item.kode });
                renderCart();
            }
            e.target.value = '';
        }
    }

    function renderCart() {
        const b = document.getElementById('cartBody'); b.innerHTML = '';
        let t = 0;
        cart.forEach(c => {
            let s = c.harga * c.qty; t += s;
            b.innerHTML += `<tr><td>${c.nama}</td><td>${c.unit}</td><td>${c.harga.toLocaleString()}</td><td>${c.qty}</td><td>${s.toLocaleString()}</td></tr>`;
        });
        document.getElementById('total').innerText = "Rp " + t.toLocaleString();
    }

    function clearData() { if(confirm("Hapus semua database?")) db.ref('v26_master').set(null); }
    function delItem(i) { masterBrg.splice(i, 1); db.ref('v26_master').set(masterBrg); }
    
    function checkOut() {
        cart.forEach(c => {
            const idx = masterBrg.findIndex(m => m.kode === c.id);
            if(idx !== -1) masterBrg[idx].stok -= (c.qty * c.konv);
        });
        db.ref('v26_master').set(masterBrg).then(() => {
            alert("Transaksi Berhasil!");
            cart = []; renderCart();
        });
    }
</script>
</body>
</html>
